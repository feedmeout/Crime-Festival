<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#1a1a2e">
    <title>Φάκελος Υπόθεσης - Φεστιβάλ Αστυνομικής Λογοτεχνίας 2025</title>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA_9_40aa_wO_19g-1bIrSB6742aMOPwjo",
            authDomain: "crime-festival-2025.firebaseapp.com",
            projectId: "crime-festival-2025",
            storageBucket: "crime-festival-2025.firebasestorage.app",
            messagingSenderId: "663770004335",
            appId: "1:663770004335:web:e42dbd983ab9b5277bc69a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        
        console.log("✅ Firebase connected in index.html!");
    </script>

<style>

:root {
    --color-primary: #ff6b00;
    --color-primary-light: #ff8800;
    --color-primary-dark: #e66000;
    --color-bg-dark: #1a1a2e;
    --color-bg-darker: #16213e;
    --color-success: #28a745;
    --color-success-light: #20c997;
    --color-danger: #dc3545;
    --color-danger-dark: #c82333;
    --color-warning: #ffc107;
    --color-info: #2196f3;
    --color-text-dark: #1a1a2e;
    --color-text-light: #fff;
    --color-text-gray: #666;
    --color-border: #ddd;
    
    --spacing-xs: 0.5rem;
    --spacing-sm: 1rem;
    --spacing-md: 1.5rem;
    --spacing-lg: 2rem;
    --spacing-xl: 3rem;
    
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 12px;
    --radius-xl: 15px;
    
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.2);
    --shadow-lg: 0 10px 40px rgba(0,0,0,0.3);
    --shadow-primary: 0 4px 15px rgba(255,107,0,0.3);
    
    --transition-fast: 0.2s ease;
    --transition-normal: 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    min-height: 100vh;
    background: linear-gradient(135deg, var(--color-bg-dark) 0%, var(--color-bg-darker) 100%);
    position: relative;
    overflow-x: hidden;
    line-height: 1.6;
}

.animated-background {
    position: absolute;
    inset: 0;
    opacity: 0.1;
    background-image: repeating-linear-gradient(
        45deg, 
        transparent, 
        transparent 35px, 
        rgba(255,107,0,0.5) 35px, 
        rgba(255,107,0,0.5) 70px
    );
    animation: slide 20s linear infinite;
    pointer-events: none;
}

@keyframes slide {
    0% { transform: translateX(0); }
    100% { transform: translateX(70px); }
}

@keyframes swing {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes blink {
    0%, 80%, 100% { opacity: 0; }
    40% { opacity: 1; }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translate(-50%, -60%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
}

.header {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    padding: clamp(1.25rem, 4vw, 1.875rem);
    box-shadow: var(--shadow-lg);
    position: relative;
    z-index: 10;
    text-align: center;
}

.header h1 {
    color: #000;
    font-size: clamp(1.125rem, 5vw, 2rem);
    font-weight: bold;
    letter-spacing: clamp(1px, 0.3vw, 2px);
    text-shadow: 2px 2px 4px rgba(255,255,255,0.3);
    margin-bottom: 0.625rem;
    word-wrap: break-word;
}

.header p {
    color: #1a1a1a;
    font-size: clamp(0.8125rem, 3vw, 1rem);
    font-weight: bold;
}

.team-info {
    background: rgba(0,0,0,0.2);
    padding: clamp(0.5rem, 2vw, 0.625rem) clamp(0.9375rem, 3vw, 1.25rem);
    border-radius: var(--radius-md);
    margin-top: 0.9375rem;
    display: block;
    max-width: 96%;
    margin-inline: auto;
}

.team-info strong {
    color: var(--color-text-light);
    font-size: clamp(0.75rem, 2.5vw, 0.875rem);
    text-transform: uppercase;
}

.logout-btn {
    position: absolute;
    top: clamp(0.9375rem, 3vw, 1.25rem);
    right: clamp(0.625rem, 2vw, 1.25rem);
    padding: clamp(0.625rem, 2vw, 0.75rem) clamp(0.75rem, 2.5vw, 1.25rem);
    background: var(--color-danger);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: clamp(0.6875rem, 2vw, 0.875rem);
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(220,53,69,0.3);
    transition: all var(--transition-fast);
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220,53,69,0.5);
}

.container {
    padding: clamp(1.25rem, 4vw, 2.5rem) clamp(0.9375rem, 3vw, 1.25rem);
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
}

.timer-section {
    background: rgba(255, 255, 255, 0.95);
    border: 3px solid var(--color-info);
    border-radius: var(--radius-lg);
    padding: clamp(0.9375rem, 3vw, 1.25rem);
    margin-bottom: 1.25rem;
    box-shadow: var(--shadow-lg);
    display: none;
}

.timer-section h2 {
    color: var(--color-text-dark);
    font-size: clamp(0.875rem, 3vw, 1rem);
    margin-bottom: 0.9375rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.timer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.625rem;
}

.timer-box {
    background: #f8f9fa;
    padding: clamp(0.75rem, 2.5vw, 0.9375rem);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-info);
    min-height: 70px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.timer-box strong {
    display: block;
    color: #0f3460;
    font-size: clamp(0.625rem, 2vw, 0.6875rem);
    margin-bottom: 6px;
    text-transform: uppercase;
}

.timer-box .value {
    font-size: clamp(1.125rem, 4vw, 1.25rem);
    font-weight: bold;
    color: var(--color-info);
    font-family: monospace;
}

.tabs-container {
    margin-bottom: clamp(1.5625rem, 5vw, 2.5rem);
}

.tabs-nav {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5625rem;
    flex-wrap: wrap;
    background: rgba(0, 0, 0, 0.2);
    padding: clamp(0.75rem, 2.5vw, 0.9375rem);
    border-radius: var(--radius-lg);
}

.tab-button {
    flex: 1 1 auto;
    min-width: clamp(120px, 30%, 150px);
    padding: clamp(0.75rem, 2.5vw, 0.9375rem) clamp(0.9375rem, 3vw, 1.25rem);
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 107, 0, 0.3);
    border-radius: var(--radius-md);
    color: var(--color-text-light);
    font-size: clamp(0.6875rem, 2.5vw, 0.875rem);
    font-weight: bold;
    cursor: pointer;
    transition: all var(--transition-normal);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.tab-button:hover,
.tab-button:focus {
    background: rgba(255, 107, 0, 0.2);
    border-color: rgba(255, 107, 0, 0.6);
    transform: translateY(-2px);
    outline: none;
}

.tab-button.active {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    border-color: var(--color-primary);
    box-shadow: var(--shadow-primary);
    color: #000;
}

.tabs-content {
    position: relative;
}

.tab-pane {
    display: none;
    animation: fadeIn var(--transition-normal);
}

.tab-pane.active {
    display: block;
}

.intro-box,
.forensic-box,
.timeline-box,
.story-box {
    background: rgba(255, 255, 255, 0.95);
    border: 3px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: clamp(1.25rem, 4vw, 1.875rem);
    margin-bottom: clamp(1.5625rem, 5vw, 2.5rem);
    box-shadow: var(--shadow-lg);
}

.forensic-box {
    border-color: var(--color-success);
}

.timeline-box,
.story-box {
    border-color: #6c757d;
}

.intro-box h2,
.forensic-box h2,
.timeline-box h2,
.story-box h2 {
    color: var(--color-text-dark);
    font-size: clamp(1rem, 3.5vw, 1.125rem);
    text-transform: uppercase;
    border-bottom: 2px solid #000;
    padding-bottom: 0.5rem;
    margin-bottom: clamp(0.9375rem, 3vw, 1.25rem);
    letter-spacing: 1px;
}

.intro-box p,
.forensic-box p,
.timeline-box p,
.story-box p {
    color: #333;
    line-height: 1.7;
    font-size: clamp(0.8125rem, 2.8vw, 0.875rem);
    margin: 0.75rem 0;
    text-align: justify;
    word-wrap: break-word;
}

.intro-box p strong,
.forensic-box p strong {
    color: #000;
}

.red-highlight {
    color: var(--color-danger);
    font-weight: bold;
    background: rgba(220,53,69,0.1);
    padding: 2px 6px;
    border-radius: 3px;
}

.timeline-item {
    margin: 0.5rem 0;
    padding-left: clamp(1.125rem, 4vw, 1.25rem);
    position: relative;
    color: #333;
    font-size: clamp(0.75rem, 2.8vw, 0.8125rem);
    line-height: 1.6;
    text-align: justify;
    word-wrap: break-word;
}

.timeline-item::before {
    content: "◉";
    position: absolute;
    left: 0;
    font-size: 0.6875rem;
    color: #000;
}

.timeline-item strong {
    color: var(--color-text-dark);
    font-weight: 600;
}

.timeline-critical {
    color: var(--color-danger);
    font-weight: bold;
    background: rgba(220,53,69,0.1);
    padding: 2px 6px;
    border-radius: 3px;
}

.progress-bar-container {
    background: rgba(255, 255, 255, 0.95);
    border: 3px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: clamp(1.25rem, 4vw, 1.5625rem);
    margin-bottom: clamp(1.5625rem, 5vw, 2.5rem);
    box-shadow: var(--shadow-lg);
}

.progress-title {
    color: var(--color-text-dark);
    font-size: clamp(1rem, 4vw, 1.25rem);
    margin-bottom: 0.9375rem;
    font-weight: bold;
}

.progress-bar {
    background: #e0e0e0;
    height: clamp(1.5625rem, 5vw, 1.875rem);
    border-radius: var(--radius-xl);
    overflow: hidden;
    position: relative;
    margin-bottom: 0.625rem;
}

.progress-fill {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    height: 100%;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: clamp(0.75rem, 3vw, 0.875rem);
}

.progress-text {
    color: var(--color-text-gray);
    font-size: clamp(0.8125rem, 3vw, 1rem);
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 4px;
    padding: 10px;
    background: rgba(255, 107, 0, 0.05);
    border-radius: 8px;
    margin-top: 10px;
}

.section-title {
    color: var(--color-text-light);
    margin-bottom: 1.5625rem;
    font-size: clamp(1.125rem, 4vw, 1.5rem);
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding-bottom: 0.625rem;
    border-bottom: 2px solid rgba(255, 107, 0, 0.5);
    flex-wrap: wrap;
}

.evidence-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 300px), 1fr));
    gap: clamp(0.9375rem, 3vw, 1.5625rem);
    margin-bottom: clamp(1.5625rem, 5vw, 2.5rem);
}

.evidence-card {
    background: rgba(255, 255, 255, 0.95);
    border: 3px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: clamp(1.125rem, 4vw, 1.5625rem);
    box-shadow: var(--shadow-lg);
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
    position: relative;
    min-height: 200px;
    display: flex;
    flex-direction: column;
}

.evidence-card.unlocked:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 50px rgba(255, 107, 0, 0.4);
}

.evidence-card.locked {
    opacity: 0.6;
    border-color: #999;
    background: rgba(200, 200, 200, 0.95);
}

.evidence-header {
    display: flex;
    align-items: center;
    gap: clamp(0.625rem, 2vw, 0.9375rem);
    margin-bottom: 0.9375rem;
}

.evidence-icon {
    width: clamp(50px, 10vw, 60px);
    height: clamp(50px, 10vw, 60px);
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(1.5rem, 5vw, 1.875rem);
    box-shadow: var(--shadow-primary);
    flex-shrink: 0;
}

.evidence-card.locked .evidence-icon {
    background: linear-gradient(135deg, #999 0%, #666 100%);
    filter: grayscale(100%);
}

.evidence-info h3 {
    color: var(--color-text-dark);
    font-size: clamp(1rem, 3.5vw, 1.25rem);
    margin-bottom: 5px;
    font-family: monospace;
    letter-spacing: 1px;
    word-wrap: break-word;
}

.evidence-card.locked .evidence-info h3 {
    color: var(--color-text-gray);
}

.evidence-info p {
    color: var(--color-text-gray);
    font-size: clamp(0.75rem, 2.5vw, 0.875rem);
    line-height: 1.4;
}

.evidence-description {
    color: #333;
    line-height: 1.6;
    margin-bottom: 1.25rem;
    font-size: clamp(0.75rem, 2.8vw, 0.875rem);
    flex-grow: 1;
    text-align: justify;
}

.evidence-card.locked .evidence-description {
    color: #999;
}

.evidence-actions {
    display: flex;
    gap: 0.625rem;
    flex-wrap: wrap;
    margin-top: auto;
    width: 100%;
}

.evidence-actions .btn {
    width: 100%;
    text-align: center;
}

.critical-tag {
    position: absolute;
    top: clamp(0.75rem, 2.5vw, 0.9375rem);
    right: clamp(0.75rem, 2.5vw, 0.9375rem);
    background: var(--color-danger);
    color: white;
    padding: clamp(3px, 1vw, 4px) clamp(6px, 1.5vw, 8px);
    border-radius: 4px;
    font-size: clamp(0.5625rem, 2vw, 0.6875rem);
    font-weight: bold;
}

.lock-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: clamp(2.25rem, 8vw, 3rem);
    opacity: 0.3;
}

.status-badge {
    display: inline-block;
    padding: clamp(5px, 1.5vw, 6px) clamp(0.625rem, 2vw, 0.75rem);
    border-radius: var(--radius-sm);
    font-size: clamp(0.6875rem, 2.2vw, 0.75rem);
    font-weight: bold;
    margin-top: 0.625rem;
    text-align: left;
    width: 100%;
}

.status-unlocked {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-locked {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.suspects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 320px), 1fr));
    gap: clamp(1.125rem, 4vw, 1.5625rem);
    margin-top: 1.25rem;
}

.suspect-card {
    background: rgba(255, 255, 255, 0.95);
    border: 3px solid var(--color-danger);
    border-radius: var(--radius-lg);
    padding: clamp(0.9375rem, 3vw, 1.25rem);
    box-shadow: 0 10px 40px rgba(220, 53, 69, 0.3);
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
}

.suspect-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 50px rgba(220, 53, 69, 0.5);
}

.suspect-photo-container {
    position: relative;
    width: 100%;
    display: flex;
    justify-content: center;
    margin-bottom: 0.9375rem;
}

.suspect-canvas {
    border: 3px solid #333;
    box-shadow: 3px 3px 8px rgba(0,0,0,0.4);
    transform: rotate(-1deg);
    background: #f5f5f5;
    max-width: 100%;
    height: auto;
}

.suspect-number {
    position: absolute;
    top: -10px;
    right: 10px;
    background: var(--color-danger);
    color: white;
    padding: clamp(4px, 1vw, 5px) clamp(0.625rem, 2vw, 0.75rem);
    border-radius: var(--radius-sm);
    font-size: clamp(0.625rem, 2vw, 0.6875rem);
    font-weight: bold;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
}

.suspect-details {
    font-size: clamp(0.75rem, 2.8vw, 0.8125rem);
    line-height: 1.6;
}

.suspect-details h3 {
    color: var(--color-text-dark);
    font-size: clamp(0.875rem, 3vw, 1rem);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--color-danger);
    font-family: monospace;
    letter-spacing: 0.5px;
}

.suspect-field {
    margin-bottom: 0.625rem;
    padding: clamp(6px, 1.5vw, 8px);
    background: rgba(0,0,0,0.02);
    border-radius: 4px;
    text-align: justify;
    word-wrap: break-word;
}

.suspect-field strong {
    color: var(--color-danger);
    display: block;
    margin-bottom: 3px;
    font-size: clamp(0.625rem, 2.2vw, 0.6875rem);
    letter-spacing: 0.5px;
}

.solution-form {
    background: white;
    padding: clamp(1.25rem, 4vw, 1.5625rem);
    border-radius: var(--radius-md);
    margin: 1.25rem 0;
}

.solution-form h3 {
    color: var(--color-text-dark);
    margin-bottom: 1.25rem;
    font-size: clamp(1rem, 3.5vw, 1.25rem);
}

.suspect-options {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 250px), 1fr));
    gap: clamp(0.75rem, 2.5vw, 0.9375rem);
    margin: 1.25rem 0;
}

.suspect-option {
    background: #f8f9fa;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: clamp(0.75rem, 2.5vw, 0.9375rem);
    transition: all var(--transition-normal);
    cursor: pointer;
    min-height: 56px;
    display: flex;
    align-items: center;
}

.suspect-option:hover {
    border-color: var(--color-primary);
    background: #fff5f0;
    transform: translateY(-2px);
}

.suspect-option input[type="checkbox"] {
    width: clamp(20px, 4vw, 24px);
    height: clamp(20px, 4vw, 24px);
    margin-right: clamp(0.625rem, 2vw, 0.75rem);
    cursor: pointer;
    flex-shrink: 0;
}

.suspect-option label {
    cursor: pointer;
    display: flex;
    align-items: center;
    font-weight: bold;
    color: var(--color-text-dark);
    font-size: clamp(0.8125rem, 2.8vw, 0.875rem);
    flex-grow: 1;
}

.suspect-option input[type="checkbox"]:checked + label {
    color: var(--color-primary);
}

.form-group {
    margin: clamp(1.125rem, 4vw, 1.25rem) 0;
}

.form-group label {
    display: block;
    font-weight: bold;
    color: var(--color-text-dark);
    margin-bottom: 0.625rem;
    font-size: clamp(0.8125rem, 2.8vw, 0.875rem);
}

.form-group textarea {
    width: 100%;
    min-height: clamp(120px, 25vw, 150px);
    padding: clamp(0.75rem, 2.5vw, 0.9375rem);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: clamp(0.8125rem, 2.8vw, 0.875rem);
    font-family: inherit;
    resize: vertical;
}

.form-group input[type="number"] {
    width: 100%;
    max-width: 200px;
    padding: clamp(0.625rem, 2vw, 0.75rem);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: clamp(0.875rem, 3vw, 1rem);
    min-height: 48px;
}

.form-group textarea:focus,
.form-group input:focus {
    outline: none;
    border-color: var(--color-primary);
}

.btn {
    padding: clamp(0.75rem, 2.5vw, 0.875rem) clamp(1.25rem, 4vw, 1.5rem);
    border-radius: var(--radius-md);
    font-weight: bold;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    font-size: clamp(0.75rem, 2.8vw, 0.875rem);
    border: 2px solid transparent;
    cursor: pointer;
    min-height: 48px;
    min-width: 48px;
    text-align: center;
}

.btn:hover:not(:disabled),
.btn:focus:not(:disabled) {
    transform: translateY(-2px);
    outline: none;
}

.btn-ar {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    color: white;
    box-shadow: var(--shadow-primary);
}

.btn-ar:hover:not(:disabled) {
    box-shadow: 0 6px 20px rgba(255, 107, 0, 0.5);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #ccc;
    color: var(--color-text-gray);
}

.btn-primary {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    color: #000;
    font-weight: bold;
}

.submit-btn {
    background: linear-gradient(135deg, var(--color-success) 0%, var(--color-success-light) 100%);
    color: white;
    padding: clamp(0.875rem, 3vw, 1rem) clamp(1.875rem, 6vw, 2.5rem);
    border: none;
    border-radius: var(--radius-md);
    font-size: clamp(0.9375rem, 3.5vw, 1.125rem);
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(40,167,69,0.3);
    transition: all var(--transition-fast);
    width: 100%;
    min-height: 56px;
}

.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40,167,69,0.5);
}

.info-box {
    background: #e3f2fd;
    border-left: 4px solid var(--color-info);
    padding: clamp(0.75rem, 2.5vw, 0.9375rem);
    border-radius: var(--radius-md);
    margin: 0.9375rem 0;
    font-size: clamp(0.75rem, 2.5vw, 0.8125rem);
    color: #0d47a1;
    line-height: 1.6;
}

.survey-tab-content {
    text-align: center;
    padding: clamp(1.875rem, 8vw, 3.75rem) clamp(1.25rem, 5vw, 2.5rem);
}

.survey-icon {
    font-size: clamp(3.125rem, 15vw, 5rem);
    margin-bottom: clamp(1.25rem, 5vw, 1.875rem);
}

.survey-title {
    font-size: clamp(1.125rem, 4vw, 1.75rem) !important;
    margin-bottom: clamp(0.9375rem, 4vw, 1.25rem) !important;
}

.intro-box .survey-btn.btn.btn-primary {
    font-size: clamp(1rem, 3.5vw, 1.25rem);
    padding: clamp(0.9375rem, 3vw, 1.25rem) clamp(1.875rem, 6vw, 3.125rem);
}

.stat-card {
    background: white;
    padding: 1.25rem 0.9375rem;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    text-align: center;
}

.stat-card h3 {
    color: var(--color-text-gray);
    font-size: clamp(0.6875rem, 2.5vw, 0.875rem);
    margin-bottom: 0.625rem;
    text-transform: uppercase;
}

.stat-card .value {
    font-size: clamp(1.5rem, 6vw, 2rem);
    font-weight: bold;
    color: var(--color-primary);
}

.loading-dots {
    display: inline-block;
    margin-left: 5px;
}

.loading-dots span {
    animation: blink 1.4s infinite;
    animation-fill-mode: both;
}

.loading-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.loading-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

.footer {
    background: rgba(255, 255, 255, 0.1);
    padding: clamp(0.9375rem, 3vw, 1.25rem);
    text-align: center;
    color: var(--color-text-light);
    border-top: 2px solid rgba(255, 107, 0, 0.3);
    margin-top: clamp(1.875rem, 6vw, 2.5rem);
}

.footer p {
    margin: 5px 0;
    font-size: clamp(0.75rem, 2.5vw, 0.875rem);
    opacity: 0.9;
}

*:focus-visible {
    outline: 3px solid var(--color-primary);
    outline-offset: 2px;
}

button:focus-visible,
.btn:focus-visible,
.tab-button:focus-visible {
    outline: 3px solid var(--color-primary);
    outline-offset: 2px;
}

@media (min-width: 576px) {
    .header {
        padding: 1.5625rem 1.25rem;
    }
    
    .header h1 {
        font-size: clamp(1.5rem, 5vw, 1.75rem);
    }
    
    .tabs-nav {
        gap: 0.625rem;
    }
    
    .tab-button {
        min-width: 140px;
    }
    
    .evidence-grid,
    .suspects-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    
    .suspect-options {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    }
    
    .submit-btn {
        width: auto;
        min-width: 200px;
    }
}

@media (min-width: 768px) {
    .header {
        padding: 1.875rem 1.25rem;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .header p {
        font-size: 1rem;
    }
    
    .container {
        padding: 2.5rem 1.25rem;
    }
    
    .tabs-nav {
        flex-wrap: nowrap;
    }
    
    .tab-button {
        flex: 1;
        min-width: 150px;
    }
    
    .evidence-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    }
    
    .suspects-grid {
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }
    
    .suspect-options {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    
    .timer-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1024px) {
    .evidence-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    }
    
    .suspects-grid {
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }
    
    .evidence-actions {
        flex-direction: row;
    }
    
    .btn {
        width: auto;
    }
}

@media (min-width: 1440px) {
    .container {
        max-width: 1400px;
    }
}

@media (max-width: 768px) and (orientation: landscape) {
    .header {
        padding: 0.9375rem 1.25rem;
    }
    
    .container {
        padding: 1.25rem 0.9375rem;
    }
    
    .timer-section h2 {
        font-size: 0.875rem;
    }
    
    .tab-button {
        padding: 0.625rem 0.9375rem;
        min-height: 42px;
    }
}

@media print {
    .animated-background,
    .header button,
    .tabs-nav,
    .evidence-actions {
        display: none !important;
    }
    
    .container {
        max-width: 100%;
        padding: 1.25rem;
    }
    
    .tab-pane {
        display: block !important;
    }
}
</style>

</head>

<body>
    <div class="animated-background"></div>

    <div class="header">
        <h1>⚠️ ΦΑΚΕΛΟΣ ΥΠΟΘΕΣΗΣ ⚠️</h1>
        <div class="team-info" id="teamInfo" style="display: none;">
            <strong id="teamName"></strong>
        </div>
    </div>

    <div class="container">
        <div class="timer-section" id="timerSection">
            <h2>⏱️ ΧΡΟΝΟΜΕΤΡΗΣΗ ΟΜΑΔΑΣ</h2>
            <div class="timer-grid">
                <div class="timer-box">
                    <strong>Έναρξη</strong>
                    <div class="value" id="startTime">--:--</div>
                </div>
                <div class="timer-box">
                    <strong id="liveTimerLabel">Χρόνος</strong>
                    <div class="value" id="liveTimer">0λ 0δ</div>
                </div>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="intro">📋 ΠΕΡΙΣΤΑΤΙΚΟ</button>
                <button class="tab-button" data-tab="forensics">🥼 ΙΑΤΡΟΔΙΚΑΣΤΙΚΗ & ΧΡΟΝΟΛΟΓΙΟ</button>
                <button class="tab-button" data-tab="suspects">👥 ΚΑΤΑΛΟΓΟΣ ΥΠΟΠΤΩΝ</button>
                <button class="tab-button" data-tab="evidence">📦 ΤΕΚΜΗΡΙΑ</button>
                <button class="tab-button" data-tab="solution">✅ ΛΥΣΗ</button>
                <button class="tab-button" data-tab="survey">📊 ΕΡΕΥΝΑ</button>
                <button class="tab-button" data-tab="results">🏆 ΚΑΤΑΤΑΞΗ</button>
            </div>

            <div class="tabs-content">
                <div class="tab-pane active" id="tab-intro">
                    <div class="intro-box">
                        <h2>📋 ΠΕΡΙΣΤΑΤΙΚΟ</h2>
                        <p><strong>ΘΥΜΑ:</strong> ΔΗΜΗΤΡΙΟΥ ΠΕΤΡΟΣ του ΙΩΑΝΝΗ, ΑΦΜ: 074XXXXXX</p>
                        <p><strong>ΗΛΙΚΙΑ:</strong> 55 ετών | <strong>ΟΙΚ. ΚΑΤΑΣΤΑΣΗ:</strong> Παντρεμένος, 2 τέκνα</p>
                        <p><strong>ΕΠΑΓΓΕΛΜΑ:</strong> Εκδότης, Ιδρυτής/CEO «ΛΟΓΟΣ ΕΚΔΟΣΕΙΣ Α.Ε.»</p>
                        <p><strong>ΤΟΠΟΣ ΕΥΡΕΣΗΣ:</strong> Ιδιωτικό γραφείο, Σταδίου 47, 7ος όροφος</p>
                        <p><strong>ΗΜΕΡΑ ΕΥΡΕΣΗΣ:</strong> Τρίτη 23/09, 07:15 π.μ. | <strong>ΚΛΗΣΗ ΑΣΤΥΝΟΜΙΑΣ:</strong> 07:18</p>
                        <p style="font-style: italic; color: #00008b; margin-top: 15px;">Σημείωση: Ασφάλεια ζωής €1εκ. - ακυρώνεται σε περίπτωση αυτοκτονίας</p>
                    </div>

                    <div class="story-box">
                        <h2>📖 Η ΥΠΟΘΕΣΗ</h2>
                        <p>Ο Πέτρος Δημητρίου ήταν γνωστός εκδοτικός μεγιστάνας με επιτυχημένη καριέρα τριών δεκαετιών. Πριν από τρεις εβδομάδες έλαβε μια διάγνωση που άλλαξε τα πάντα: καρκίνος παγκρέατος τελικού σταδίου, με προσδόκιμο ζωής 2-3 μήνες. Η είδηση ήταν γνωστή μόνο στον ιατρό του, τη γραμματέα του και την σύζυγό του.</p>
                        <p>Το πρωί της Τρίτης 23 Σεπτεμβρίου, η προσωπική γραμματέας <strong>Μαρία Παπαδοπούλου</strong> φτάνει στο γραφείο νωρίτερα από το συνηθισμένο (07:15 αντί για 08:30) και ανακαλύπτει το άψυχο σώμα του Δημητρίου στις τουαλέτες του 7ου ορόφου. Στον υπολογιστή του γραφείου βρέθηκε ένα email «αυτοκτονίας» αποσταλμένο στις 21:25 το προηγούμενο βράδυ. Οι πρώτες ενδείξεις έδειχναν αυτοκτονία από δηλητηρίαση με κυάνιο.</p>
                        <p>Ωστόσο, η εξέταση της σκηνής και η ανάκριση του προσωπικού αποκάλυψαν ανωμαλίες που προκαλούν υποψίες...</p>
                    </div>
                </div>

                <div class="tab-pane" id="tab-forensics">
					<div class="forensic-box">
						<h2>🥼 ΙΑΤΡΟΔΙΚΑΣΤΙΚΗ ΕΚΘΕΣΗ</h2>
						<p><strong>ΤΟΠΟΣ ΕΥΡΕΣΗΣ:</strong> Τουαλέτες, 7ος όροφος (το θύμα κινήθηκε από το γραφείο προς τις τουαλέτες μετά την κατάποση)</p>
						<p><strong>ΩΡΑ ΘΑΝΑΤΟΥ:</strong> 21:30 - 21:50 (εκτιμώμενο εύρος)</p>
						<p><strong>ΑΙΤΙΑ:</strong> Οξεία δηλητηρίαση από κυανιούχο κάλιο (75mg εντερικά)</p>
						<p><strong>ΤΟΞΙΚΟΛΟΓΙΚΗ:</strong> Αλκοόλ 0.12% (2-3 ποτά), Αλπραζολάμη 2mg (θεραπευτική δόση)</p>
						<p><strong>ΣΗΜΕΙΩΣΗ:</strong> Το αλπραζολάμη επιταχύνει την απορρόφηση κυανίου και ενισχύει τη δηλητηριώδη δράση κατά 40-60%</p>
						<p><strong>ΕΚΤΙΜΗΣΗ:</strong> Ο θάνατος επήλθε 5-15 λεπτά μετά την κατάποση</p>
						<p><strong>ΤΡΑΥΜΑΤΑ:</strong> Κανένα αμυντικό τραύμα</p>
						<p><strong>ΠΑΘΟΛΟΓΙΚΗ:</strong> <span class="red-highlight">Καρκίνος παγκρέατος τελικού σταδίου - προσδόκιμο ζωής 2-3 μήνες</span></p>
					</div>

					<div class="timeline-box">
						<h2>🕐 ΧΡΟΝΟΛΟΓΙΟ ΣΥΜΒΑΝΤΩΝ</h2>
						<div class="timeline-item"><strong>17:30-18:30</strong> - Οι περισσότεροι υπάλληλοι αποχωρούν από το κτίριο</div>
						<div class="timeline-item"><strong>18:30</strong> - Νικολάου φεύγει από το κτίριο (κάμερες εξόδου)</div>
						<div class="timeline-item"><strong>19:00</strong> - Παράδοση φαγητού στο γραφείο του Δημητρίου (για 1 άτομο - ο Δημητρίου τρώει μόνος, αναμένει Αναγνώστου αργότερα)</div>
						<div class="timeline-item"><strong>20:00</strong> - Πετρόπουλος αναλαμβάνει βάρδια</div>
						<div class="timeline-item"><strong>20:22</strong> - Ψηφιακό log: Έλεγχος 7ου ορόφου από Πετρόπουλο</div>
						<div class="timeline-item"><strong>20:37</strong> - Αναγνώστου στάση σε περίπτερο για τσιγάρα (πληρωμή με κάρτα)</div>
						<div class="timeline-item"><strong>20:40</strong> - Μαυρίδη εισέρχεται στο κτίριο (κάρτα εισόδου) να αφήσει αντίτυπα</div>
						<div class="timeline-item"><strong>20:45</strong> - SMS στο κινητό Δημητρίου: «Θα τελειώσει απόψε»</div>
						<div class="timeline-item"><strong>20:48</strong> - Νυχτερινή καθαρίστρια (Ελένη Κ.) είδε Πετρόπουλο στον 3ο όροφο</div>
						<div class="timeline-item"><strong>20:49</strong> - Αναγνώστου εισέρχεται στο κτίριο (κάρτα εισόδου)</div>
						<div class="timeline-item"><strong>20:53</strong> - Μη εξουσιοδοτημένη πρόσβαση στο σύστημα κάμερων (τεχνικό log)</div>
						<div class="timeline-item"><strong>20:55</strong> - Κάμερες απενεργοποιούνται</div>
						<div class="timeline-item"><strong>21:27</strong> - Μαυρίδη φεύγει (κάρτα parking)</div>
						<div class="timeline-item"><strong>21:30-21:50</strong> - <span class="timeline-critical">ΘΑΝΑΤΟΣ ΔΗΜΗΤΡΙΟΥ</span></div>
						<div class="timeline-item"><strong>21:35</strong> - Email «αυτοκτονίας» αποστέλλεται</div>
						<div class="timeline-item"><strong>21:42</strong> - Επαναλειτουργία κάμερων (αυτόματη επαναφορά)</div>
						<div class="timeline-item"><strong>21:55</strong> - Αναγνώστου φεύγει (κάρτα εξόδου)</div>
						<div class="timeline-item"><strong>22:10</strong> - Παπαδοπούλου εισέρχεται (κάρτα εισόδου) - συνειδητοποίησε ότι ξέχασε τα φάρμακα της, επέστρεψε να τα πάρει από το συρτάρι της</div>
						<div class="timeline-item"><strong>22:17</strong> - Παπαδοπούλου φεύγει (κάρτα εξόδου)</div>
						<div class="timeline-item"><strong>07:15 (επόμενη μέρα, 23/09)</strong> - Ανακάλυψη πτώματος από Παπαδοπούλου (γραμματέας, ήρθε νωρίτερα από συνήθως)</div>
					</div>
                </div>

                <div class="tab-pane" id="tab-suspects">
                    <div id="suspectsContainer"></div>
                </div>

                <div class="tab-pane" id="tab-evidence">
                    <div class="progress-bar-container">
                        <div class="progress-title">📊 ΠΡΟΟΔΟΣ ΕΡΕΥΝΑΣ</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
<div class="progress-text" id="progressText">
    <span style="font-weight: bold; color: #ff6b00;">ΕΧΕΤΕ ΞΕΚΛΕΙΔΩΣΕΙ</span>
    <span id="unlockedCount" style="font-size: 1.3em; font-weight: bold; color: #28a745; margin: 0 8px;">0</span>
    <span style="font-weight: bold; color: #ff6b00;">ΑΠΟ</span>
    <span id="totalCount" style="font-size: 1.3em; font-weight: bold; color: #1a1a2e; margin: 0 8px;">11</span>
    <span style="font-weight: bold; color: #ff6b00;">ΤΕΚΜΗΡΙΑ</span>
    <span id="progressEmoji" style="font-size: 1.5em; margin-left: 10px;">🔒</span>
</div>
                    </div>

                    <h2 class="section-title">📦 ΤΕΚΜΗΡΙΑ</h2>
                    <div class="evidence-grid" id="evidenceGrid"></div>
                </div>

                <div class="tab-pane" id="tab-solution">
                    <div class="intro-box" id="solutionIntroBox">
                        <h2>✅ ΥΠΟΒΟΛΗ ΛΥΣΗΣ</h2>
                        <p>Έχετε μελετήσει όλα τα τεκμήρια και είστε έτοιμοι να υποβάλετε τη λύση σας;</p>
                    </div>

                    <div class="solution-form" id="solutionForm">
                        <h3 style="color: #1a1a2e; margin-bottom: 20px;">ΕΠΙΛΟΓΗ</h3>
                        
                        <div class="suspect-options">
                            <div class="suspect-option">
                                <input type="checkbox" id="suspect_maria" name="suspect" value="maria">
                                <label for="suspect_maria">👩 Παπαδοπούλου Μαρία</label>
                            </div>
                            
                            <div class="suspect-option">
                                <input type="checkbox" id="suspect_konstantinos" name="suspect" value="konstantinos">
                                <label for="suspect_konstantinos">👨‍💼 Αναγνώστου Κωνσταντίνος</label>
                            </div>
                            
                            <div class="suspect-option">
                                <input type="checkbox" id="suspect_eleni" name="suspect" value="eleni">
                                <label for="suspect_eleni">👩‍🦰 Μαυρίδη Ελένη</label>
                            </div>
                            
                            <div class="suspect-option">
                                <input type="checkbox" id="suspect_georgios" name="suspect" value="georgios">
                                <label for="suspect_georgios">👮 Πετρόπουλος Γεώργιος</label>
                            </div>
                            
                            <div class="suspect-option">
                                <input type="checkbox" id="suspect_alexandra" name="suspect" value="alexandra">
                                <label for="suspect_alexandra">👩‍💻 Νικολάου Αλεξάνδρα</label>
                            </div>
                            
                            <div class="suspect-option">
                                <input type="checkbox" id="suspect_suicide" name="suspect" value="suicide">
                                <label for="suspect_suicide">💀 Αυτοκτονία</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="justification">ΑΙΤΙΟΛΟΓΗΣΗ ΛΥΣΗΣ: *</label>
                            <textarea 
                                id="justification" 
                                placeholder="Προσθέστε την ανάλυση / αιτιολόγησή σας..."
                                required
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label for="promptCount">ΑΡΙΘΜΟΣ PROMPTS ΠΟΥ ΧΡΗΣΙΜΟΠΟΙΗΣΑΤΕ: *</label>
                            <input 
                                type="number" 
                                id="promptCount" 
                                min="0" 
                                step="1" 
                                placeholder="π.χ. 5"
                                required
                            >
							<p style="font-size: 12px; color: #666; margin-top: 5px; font-style: italic;">
								Να γίνει υπό την επίβλεψη ενός Game Master
							</p>
													</div>

                        <button type="button" class="submit-btn" onclick="submitSolution()">
                            ✅ ΥΠΟΒΟΛΗ ΛΥΣΗΣ
                        </button>
                    </div>

                    <div id="solutionResult" style="display: none;"></div>
                </div>

                <div class="tab-pane" id="tab-survey">
                    <div class="intro-box survey-tab-content">
                        <div class="survey-icon">📊</div>
                        <h2 class="survey-title">ΕΡΕΥΝΑ ΑΞΙΟΛΟΓΗΣΗΣ ΑΠΟΨΕΩΝ & ΕΜΠΕΙΡΙΩΝ</h2>                     
                        <a href="#" 
                           onclick="openSurvey(); return false;" 
                           class="btn btn-primary" 
                           style="margin-top: 20px; font-size: clamp(16px, 3.5vw, 18px); padding: clamp(15px, 3vw, 18px) clamp(30px, 6vw, 40px);">
                            📊 ΜΕΤΑΒΑΣΗ ΣΤΟ ΕΡΩΤΗΜΑΤΟΛΟΓΙΟ
                        </a>
                    </div>
                </div>

                <div class="tab-pane" id="tab-results">
                    <div id="surveysIncomplete" style="display: none; padding-bottom: 80px;">
                        <div class="intro-box" style="text-align: center; padding: 60px 30px;">
                            <div style="font-size: clamp(80px, 20vw, 120px); margin-bottom: 30px;">🔒</div>
                            <h2 style="color: #1a1a2e; font-size: clamp(20px, 5vw, 28px); margin-bottom: 20px;">
                                Ολοκληρώστε Πρώτα τις Έρευνες
                            </h2>
                            <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 20px; margin: 20px auto; max-width: 500px;">
                                <div style="font-size: 24px; margin-bottom: 10px;">📋</div>
                                <div style="color: #856404; font-weight: bold; margin-bottom: 10px;">ΚΑΤΑΣΤΑΣΗ ΕΡΕΥΝΩΝ:</div>
                                <div id="surveyStatus" style="color: #666; font-size: 14px; line-height: 1.8;">
                                    <div id="preSurveyStatus">⏳ Έλεγχος...</div>
                                    <div id="postSurveyStatus">⏳ Έλεγχος...</div>
                                </div>
                            </div>
                            <a href="#" 
                               onclick="window.location.href='survey.html?team=' + encodeURIComponent(sessionStorage.getItem('teamCode')) + '&member=' + encodeURIComponent(sessionStorage.getItem('memberName')); return false;"
                               class="btn btn-primary" 
                               style="margin-top: 20px; font-size: clamp(16px, 3.5vw, 18px); padding: clamp(15px, 3vw, 18px) clamp(30px, 6vw, 40px);">
                                📊 ΜΕΤΑΒΑΣΗ ΣΤΟ ΕΡΩΤΗΜΑΤΟΛΟΓΙΟ
                            </a>
                        </div>
                    </div>

                    <div id="leaderboardLocked" style="display: none; padding-bottom: 80px;">
                        <div class="intro-box" style="text-align: center; padding: 60px 30px;">
                            <div style="font-size: clamp(80px, 20vw, 120px); margin-bottom: 30px; animation: swing 3s ease-in-out infinite;">
                                🔒
                            </div>
                            <h2 style="color: #1a1a2e; font-size: clamp(20px, 5vw, 28px); margin-bottom: 20px;">
                                ΤΑ ΑΠΟΤΕΛΕΣΜΑΤΑ ΔΕΙΝΑΙ ΑΚΟΜΑ ΔΙΑΘΕΣΙΜΑ
                            </h2>
                            <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 12px; padding: 20px; margin: 30px auto; max-width: 500px;">
                                <div style="font-size: 24px; margin-bottom: 10px;"></div>
                                <div style="color: #155724; font-weight: bold;">
                                    Η ΣΕΛΙΔΑ ΘΑ ΑΝΑΝΕΩΘΕΙ ΟΤΑΝ ΟΛΕΣ ΟΙ ΟΜΑΔΕΣ ΟΛΟΚΛΗΡΩΣΟΥΝ ΤΗΝ ΕΡΕΥΝΑ ΤΟΥΣ!!<br>
                                </div>
                            </div>
                            <p style="margin-top: 30px; color: #999; font-size: 14px;">
                                Έλεγχος ενημερώσεων<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
                            </p>
                        </div>
                    </div>

                    <div id="leaderboardUnlocked" style="display: none; padding-bottom: 80px;">
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                            <div class="stat-card">
                                <h3>Σύνολο Υποβολών</h3>
                                <div class="value" id="totalTeams">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>Τέλειες Λύσεις</h3>
                                <div class="value" id="perfectScores">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>Μέσος Όρος Βαθμών</h3>
                                <div class="value" id="avgScore">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>Μέσος Χρόνος</h3>
                                <div class="value" id="avgTime">-</div>
                            </div>
                        </div>

                        <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow-x: auto;">
                            <h2 style="color: #1a1a2e; font-size: clamp(18px, 4vw, 24px); margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #ff6b00;">
                                🏆 ΚΑΤΑΤΑΞΗ ΟΜΑΔΩΝ
                            </h2>
                            <table id="resultsTable" style="width: 100%; border-collapse: collapse; min-width: 650px; display: none;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #0f3460 0%, #16213e 100%); color: white;">
                                        <th style="padding: 12px 10px; text-align: left; font-size: clamp(11px, 2vw, 13px); text-transform: uppercase;">Θέση</th>
                                        <th style="padding: 12px 10px; text-align: left; font-size: clamp(11px, 2vw, 13px); text-transform: uppercase;">Ομάδα</th>
                                        <th style="padding: 12px 10px; text-align: left; font-size: clamp(11px, 2vw, 13px); text-transform: uppercase;">Βαθμολογία</th>
                                        <th style="padding: 12px 10px; text-align: left; font-size: clamp(11px, 2vw, 13px); text-transform: uppercase;">Τίτλος</th>
                                        <th style="padding: 12px 10px; text-align: left; font-size: clamp(11px, 2vw, 13px); text-transform: uppercase;">Χρόνος</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 40px; color: #666;">Φόρτωση...</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div id="resultsCards" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>ΦΕΣΤΙΒΑΛ ΑΣΤΥΝΟΜΙΚΗΣ ΛΟΓΟΤΕΧΝΙΑΣ 2025</strong></p>
            <p style="margin-top: 10px; opacity: 0.7; font-size: 12px;">
                11 ΤΕΚΜΗΡΙΑ | 5 ΥΠΟΠΤΟΙ | 1 ΑΛΗΘΕΙΑ
            </p>
        </div>
    </div>

<div id="alertNotification" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 30px 40px; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 10000; max-width: 500px; width: 90%; animation: slideIn 0.3s ease;">
    <div style="font-size: 48px; text-align: center; margin-bottom: 15px;">📢</div>
    <h3 style="color: white; text-align: center; margin-bottom: 15px; font-size: 20px;">ΕΙΔΟΠΟΙΗΣΗ ΑΠΟ ΔΙΟΡΓΑΝΩΤΕΣ</h3>
    <div id="alertMessageContent" style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-bottom: 20px; font-size: 16px; line-height: 1.6; text-align: center;"></div>
    <button onclick="closeAlert()" style="width: 100%; padding: 15px; background: white; color: #9c27b0; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.3s;">
        ✓ ΚΑΤΑΝΟΗΣΑ
    </button>
</div>

<div id="alertOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; backdrop-filter: blur(3px);"></div>

<script src="suspects.js"></script>

<script>
const StorageManager = {
    saveAuth(teamCode, memberName) {
        localStorage.setItem('teamCode', teamCode);
        localStorage.setItem('memberName', memberName);
        localStorage.setItem('memberAuth', 'true');
        localStorage.setItem('lastLogin', new Date().toISOString());
        sessionStorage.setItem('teamCode', teamCode);
        sessionStorage.setItem('memberName', memberName);
        sessionStorage.setItem('sessionActive', 'true');
        sessionStorage.setItem('sessionStart', new Date().toISOString());
        
        console.log('✅ Auth saved to both storages');
    },

    getAuth() {
        let teamCode = sessionStorage.getItem('teamCode') || localStorage.getItem('teamCode');
        let memberName = sessionStorage.getItem('memberName') || localStorage.getItem('memberName');
        if (!sessionStorage.getItem('teamCode') && localStorage.getItem('teamCode')) {
            console.log('🔄 Restoring session from localStorage');
            this.restoreSession();
            teamCode = sessionStorage.getItem('teamCode');
            memberName = sessionStorage.getItem('memberName');
        }
        
        return { teamCode, memberName };
    },
    
    restoreSession() {
        const teamCode = localStorage.getItem('teamCode');
        const memberName = localStorage.getItem('memberName');
        
        if (teamCode && memberName) {
            sessionStorage.setItem('teamCode', teamCode);
            sessionStorage.setItem('memberName', memberName);
            sessionStorage.setItem('sessionActive', 'true');
            sessionStorage.setItem('sessionStart', new Date().toISOString());
            return true;
        }
        return false;
    },
    
    isAuthenticated() {
        const hasLocalAuth = localStorage.getItem('memberAuth') === 'true';
        const hasTeamCode = localStorage.getItem('teamCode') !== null;
        return hasLocalAuth && hasTeamCode;
    },
    
    isSessionActive() {
        return sessionStorage.getItem('sessionActive') === 'true';
    },
    
    clearAuth() {
        localStorage.removeItem('teamCode');
        localStorage.removeItem('memberName');
        localStorage.removeItem('memberAuth');
        localStorage.removeItem('lastLogin');
        
        sessionStorage.removeItem('teamCode');
        sessionStorage.removeItem('memberName');
        sessionStorage.removeItem('sessionActive');
        sessionStorage.removeItem('sessionStart');
        
        console.log('🔴 Auth cleared from both storages');
    },
    
    async syncSessionToFirebase() {
        if (!window.firebaseDB || !this.isSessionActive()) return;
        
        const { teamCode, memberName } = this.getAuth();
        if (!teamCode || !memberName) return;
        
        try {
            const sessionDocRef = window.firebaseDoc(
                window.firebaseDB, 
                'activeSessions', 
                `${teamCode}_${memberName}`
            );
            
            await window.firebaseSetDoc(sessionDocRef, {
                teamCode,
                memberName,
                lastActive: new Date().toISOString(),
                userAgent: navigator.userAgent,
                sessionStart: sessionStorage.getItem('sessionStart')
            });
            
            console.log('✅ Session synced to Firebase');
        } catch (error) {
            console.error('Error syncing session:', error);
        }
    }
};

const teks = [
	{
		id: '1',
		name: 'Μπουκάλι Ουίσκι',
		subtitle: 'Μπουκάλι Jack Daniels',
		icon: '🍾',
		description: '<strong>Τοποθεσία:</strong> Γραφείο Δημητρίου (70% κενό)<br><strong>Χημική ανάλυση:</strong> Κυανιούχο κάλιο στον πάτο, συνολική ποσότητα 150mg (ο Δημητρίου κατάπιε ~75mg)<br><strong>Αποτυπώματα:</strong> Δημητρίου (πολλαπλά), Παπαδοπούλου (λαβή - παλαιό), Αναγνώστου (λαιμός - πρόσφατο), Πετρόπουλου (βάση - μερικό, αχνό)<br><strong>Σημείωση:</strong> Καπάκι χωρίς ίχνη κυανίου - προστέθηκε ΜΕΤΑ το άνοιγμα',
		page: 'TEK1_AR.html',
		critical: true
	},
	{
		id: '2',
		name: 'Κρυστάλλινα Ποτήρια',
		subtitle: 'Κρυστάλλινα Ποτήρια',
		icon: '🥃',
		description: '<strong>Ποτήρι Α:</strong> DNA Δημητρίου + κυάνιο + πλήρη αποτυπώματα<br><strong>Ποτήρι Β:</strong> Μερικό DNA (ΔΕΝ ταιριάζει με γνωστούς υπόπτους) + ουίσκι χωρίς κυάνιο + αποτυπώματα μερικώς σβησμένα (σκόπιμη απάλειψη)<br><strong>Συμπέρασμα:</strong> Κάποιος ήπιε μαζί του, αλλά προσπάθησε να μην αφήσει ίχνη',
		page: 'TEK2_AR.html',
		critical: true
	},
	{
		id: '3',
		name: 'Κινητό Δημητρίου',
		subtitle: 'Κινητό Δημητρίου',
		icon: '📱',
		description: '<strong>SMS 20:45:</strong> «Θα τελειώσει απόψε»<br><strong>Προπληρωμένη κάρτα</strong> - Αγορά: Περίπτερο Σταδίου, 19/09, 14:30<br><strong>Cell tower:</strong> Εντοπισμός σε ακτίνα 250m από κτίριο<br><strong>CCTV περιπτέρου:</strong> Άτομο με κουκούλα, ύψος ~165-175cm, δεν φαίνεται πρόσωπο',
		page: 'TEK3_AR.html',
		critical: false,
		threat: true
	},
	{
		id: '4',
		name: 'Email Αυτοκτονίας',
		subtitle: 'Email «Αυτοκτονίας»',
		icon: '📧',
		description: '<strong>IP:</strong> 192.168.1.23 - 7ος όροφος (κοινόχρηστος υπολογιστής αίθουσας συσκέψεων)<br><strong>Πρόσβαση:</strong> Χωρίς κωδικό - ανοιχτή συνεδρία<br><strong>Browser History:</strong><br>• 20:15 - Σύνδεση Αναγνώστου (email check)<br>• 20:52 - Άγνωστος χρήστης (10 λεπτά σύνδεση)<br>• 21:35 - Αποστολή email «αυτοκτονίας»',
		page: 'TEK4_AR.html',
		critical: false,
		forgery: true
	},
    {
        id: '5',
        name: 'Ιατρική Γνωμάτευση',
        subtitle: 'Ιατρική Γνωμάτευση (Κρυφή)',
        icon: '🥼',
        description: '<strong>Διάγνωση:</strong> Καρκίνος παγκρέατος σταδίου IV<br><strong>Ημερομηνία:</strong> 28/08/2025<br><strong>Πρόγνωση:</strong> 2-3 μήνες ζωής<br><strong>Γιατρός:</strong> Δρ. Σταυρίδης',
        page: 'TEK5_AR.html',
        critical: false,
        secret: true
    },
    {
        id: '6',
        name: 'Γάντια Λάτεξ',
        subtitle: 'Ίχνη Γαντιών Λάτεξ',
        icon: '🧤',
        description: '<strong>Τοποθεσία:</strong> Πόμολο πόρτας (εσωτερικά)<br><strong>Τύπος:</strong> Γάντια ιατρικού τύπου<br><strong>Πρόσβαση:</strong> Όλο το προσωπικό',
        page: 'TEK6_AR.html',
        critical: false,
        clue: true
    },
	{
		id: '7',
		name: 'Χειρόγραφο Σημείωμα',
		subtitle: 'Χειρόγραφο Σημείωμα',
		icon: '✍️',
		description: '<strong>Κείμενο:</strong> «Συγχώρεσέ με Μ.»<br><strong>Ανάλυση:</strong> Προσπάθεια μίμησης γραφικού χαρακτήρα Δημητρίου (68% ταύτιση, πίεση γραφής ασυνεπής με αυθεντικά δείγματα)',
		page: 'TEK7_AR.html',
		critical: false,
		forgery: true
	},
    {
        id: '8',
        name: 'Φάκελος Εμπιστευτικό',
        subtitle: 'Φάκελος «ΕΜΠΙΣΤΕΥΤΙΚΟ»',
        icon: '📂',
        description: '<strong>Περιεχόμενα:</strong><br>• Υποψίες υπεξαίρεσης (Αναγνώστου)<br>• Ερωτικές φωτογραφίες (Μαυρίδη)<br>• Κλοπή χειρογράφων (Νικολάου)<br>• Απλήρωτοι μισθοί (Παπαδοπούλου)<br>• Χρέη (Πετρόπουλος)',
        page: 'TEK8_AR.html',
        critical: false,
        blackmail: true
    },
	{
		id: '9',
		name: 'Απόδειξη Χημικών',
		subtitle: 'Απόδειξη Αγοράς Χημικών',
		icon: '🧪',
		description: '<strong>Ημερομηνία:</strong> 19/09, 14:30<br><strong>Αγορά:</strong> Κυανιούχο κάλιο 500g από «ΧημικάPlus»<br><strong>Άδεια:</strong> Επαγγελματική άδεια απεντόμωσης εταιρείας<br><strong>Υπογραφή:</strong> Δυσανάγνωστη (υπό γραφολογική εξέταση)<br><strong>Προμηθευτής:</strong> "Άνδρας 40-55 ετών, επαγγελματική στολή ασφαλείας"',
		page: 'TEK9_AR.html',
		critical: true
	},
    {
        id: '10',
        name: 'Κλειδί Χρηματοκιβωτίου',
        subtitle: 'Κλειδί Χρηματοκιβωτίου',
        icon: '🔑',
        description: '<strong>Αποτυπώματα:</strong> Δημητρίου, Αναγνώστου<br><strong>Ίχνη:</strong> Σκόνη ταλκ (από latex γάντια)',
        page: 'TEK10_AR.html',
        critical: false,
        financial: true
    },
	{
		id: '11',
		name: 'Κάμερες Ασφαλείας',
		subtitle: 'Κάμερες Ασφαλείας',
		icon: '🎥',
		description: '<strong>Απενεργοποίηση:</strong> 20:55-21:30 (διήρκεια: 35 λεπτά)<br><strong>Τετράδιο Συμβάντων:</strong> «20:58 - Τεχνική βλάβη CCTV - Αναφορά από βάρδια»<br><strong>Χειρόγραφο:</strong> ΔΕΝ ταιριάζει με κανονικό γραφικό χαρακτήρα Πετρόπουλου (υπό ανάλυση)<br><strong>Τεχνικός έλεγχος:</strong> Μη εξουσιοδοτημένη πρόσβαση στο σύστημα 20:53',
		page: 'TEK11_AR.html',
		critical: false,
		sabotage: true
	},
];

const CORRECT_SUSPECTS = ['konstantinos', 'georgios', 'eleni'];
const SUSPECT_NAMES = {
    'maria': 'Παπαδοπούλου Μαρία',
    'konstantinos': 'Αναγνώστου Κωνσταντίνος',
    'eleni': 'Μαυρίδη Ελένη',
    'georgios': 'Πετρόπουλος Γεώργιος',
    'alexandra': 'Νικολάου Αλεξάνδρα',
    'suicide': 'Αυτοκτονία'
};

const SCORING = {
    murder_diagnosis: 25,
    cooperation: 20,
    perpetrator: 15,
    perfect_solution_bonus: 20,
    evidence_use: 5,
    prompts_1_5: 15,
    prompts_6_10: 10,
    prompts_11_15: 5,
    time_under_30: 15,
    time_30_45: 10,
    time_45_60: 5
};

const urlParams = new URLSearchParams(window.location.search);
let teamCode = sessionStorage.getItem('teamName') || urlParams.get('team') || 'default';

if (teamCode !== 'default') {
    const teamInfoDiv = document.getElementById('teamInfo');
    const teamNameSpan = document.getElementById('teamName');
    if (teamInfoDiv && teamNameSpan) {
        teamInfoDiv.style.display = 'block';
        teamNameSpan.textContent = `ΟΜΑΔΑ: ${teamCode.toUpperCase()}`;
    }
}

let timerInterval = null;

function getStorageKey() {
    return `unlocked_teks_${teamCode}`;
}

function openSurvey() {
    const teamCode = sessionStorage.getItem('teamCode');
    const memberName = sessionStorage.getItem('memberName');
    
    if (!teamCode || !memberName) {
        alert('❌ Σφάλμα: Δεν βρέθηκαν στοιχεία σύνδεσης. Παρακαλώ συνδεθείτε ξανά.');
        window.location.href = 'team_entry.html';
        return;
    }

    const surveyUrl = `survey.html?team=${encodeURIComponent(teamCode)}&member=${encodeURIComponent(memberName)}`;
    window.open(surveyUrl, '_blank');
}

function getUnlockedTeks() {
    const stored = localStorage.getItem(getStorageKey());
    if (!stored) return [];
    
    try {
        const data = JSON.parse(stored);
        if (data && typeof data === 'object' && !Array.isArray(data) && data.unlocked) {
            return Array.isArray(data.unlocked) ? data.unlocked : [];
        }
        
        if (Array.isArray(data)) {
            return data;
        }
        
        return [];
    } catch (e) {
        console.error('Error loading unlocked TEKs:', e);
        return [];
    }
}

function formatElapsedTime(ms) {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    const h = hours;
    const m = minutes % 60;
    const s = seconds % 60;
    
    if (h > 0) {
        return `${h}ω ${m}λ ${s}δ`;
    } else if (m > 0) {
        return `${m}λ ${s}δ`;
    } else {
        return `${s}δ`;
    }
}

function startLiveTimer(startTime) {
    if (timerInterval) clearInterval(timerInterval);
    
    const timerElement = document.getElementById('liveTimer');
    if (!timerElement) return;
    
    timerInterval = setInterval(() => {
        const now = new Date();
        const start = new Date(startTime);
        const elapsed = now - start;
        timerElement.textContent = formatElapsedTime(elapsed);
    }, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

async function getTeamData() {
    if (window.firebaseDB) {
        try {
            const docRef = window.firebaseDoc(window.firebaseDB, 'teams', teamCode);
            const docSnap = await window.firebaseGetDoc(docRef);
            
            if (docSnap.exists()) {
                return docSnap.data();
            }
        } catch (error) {
            console.error('Firebase load error:', error);
        }
    }

    const localData = localStorage.getItem(getStorageKey());
    if (localData) {
        try {
            const parsed = JSON.parse(localData);
            if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                return {
                    password: parsed.password || null,
                    unlocked: parsed.unlocked || [],
                    timestamps: parsed.timestamps || {},
                    startTime: parsed.startTime || null,
                    completedAt: parsed.completedAt || null,
                    totalTimeMs: parsed.totalTimeMs || null,
                    solution: parsed.solution || null,
                    evidenceTimestamps: parsed.evidenceTimestamps || {}
                };
            }
            
            if (Array.isArray(parsed)) {
                return {
                    password: null,
                    unlocked: parsed,
                    timestamps: {},
                    startTime: null,
                    completedAt: null,
                    totalTimeMs: null,
                    solution: null,
                    evidenceTimestamps: {}
                };
            }
        } catch (e) {
            console.error('Error parsing localStorage data:', e);
        }
    }

    return {
        password: null,
        unlocked: [],
        timestamps: {},
        startTime: null,
        completedAt: null,
        totalTimeMs: null,
        solution: null,
        evidenceTimestamps: {}
    };
}

async function updateProgress(teamData) {
    const unlockedTeks = teamData.unlocked || [];
    const total = teks.length;
    const unlocked = unlockedTeks.length;
    const percentage = Math.round((unlocked / total) * 100);
    
    document.getElementById('progressFill').style.width = percentage + '%';
    document.getElementById('progressFill').textContent = percentage + '%';

    const unlockedCountEl = document.getElementById('unlockedCount');
    const totalCountEl = document.getElementById('totalCount');
    const progressEmoji = document.getElementById('progressEmoji');
    
    if (unlockedCountEl) unlockedCountEl.textContent = unlocked;
    if (totalCountEl) totalCountEl.textContent = total;
    
    if (progressEmoji) {
        if (percentage === 0) progressEmoji.textContent = '🔒';
        else if (percentage < 30) progressEmoji.textContent = '🔓';
        else if (percentage < 60) progressEmoji.textContent = '🔍';
        else if (percentage < 90) progressEmoji.textContent = '📋';
        else if (percentage < 100) progressEmoji.textContent = '⭐';
        else progressEmoji.textContent = '🏆';
    }
    
    const timerSection = document.getElementById('timerSection');
    if (teamData.startTime && unlocked > 0) {
        timerSection.style.display = 'block';
        document.getElementById('startTime').textContent = 
            new Date(teamData.startTime).toLocaleString('el-GR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        if (teamData.completedAt || teamData.solution) {
            document.getElementById('liveTimerLabel').textContent = 'Συνολικός Χρόνος:';
            document.getElementById('liveTimer').textContent = formatElapsedTime(teamData.totalTimeMs || 0);
            stopTimer();
        } else {
            document.getElementById('liveTimerLabel').textContent = 'Χρόνος σε Εξέλιξη:';
            if (!timerInterval) {
                startLiveTimer(teamData.startTime);
            }
        }
    } else {
        timerSection.style.display = 'none';
        stopTimer();
    }
}

function calculateScore(selectedSuspects, totalTimeMs, promptCount) {
    let score = 0;
    let breakdown = [];
    
    if (selectedSuspects.length === 0) {
        return {
            score: 0,
            breakdown: ['❌ Δεν επιλέξατε κανέναν ύποπτο ή αυτοκτονία'],
            maxScore: 140,
            correctCount: 0
        };
    }
    
    const hasSuicide = selectedSuspects.includes('suicide');
    const hasKiller = selectedSuspects.some(s => s !== 'suicide');
    
    if (hasSuicide && hasKiller) {
        const killerNames = selectedSuspects
            .filter(s => s !== 'suicide')
            .map(s => SUSPECT_NAMES[s])
            .join(', ');
        
        return {
            score: 0,
            breakdown: [
                '🚫 ΛΟΓΙΚΗ ΑΝΤΙΦΑΣΗ - Η ΥΠΟΘΕΣΗ ΔΕΝ ΜΠΟΡΕΙ ΝΑ ΕΙΝΑΙ ΤΑΥΤΟΧΡΟΝΑ ΔΟΛΟΦΟΝΙΑ ΚΑΙ ΑΥΤΟΚΤΟΝΙΑ',
                '',
                `Επιλέξατε: ${killerNames} + Αυτοκτονία`,
                '',
                '⚖️ Πρέπει να επιλέξετε ΕΙΤΕ δολοφονία ΕΙΤΕ αυτοκτονία, όχι και τα δύο.',
            ],
            maxScore: 140,
            correctCount: 0
        };
    }

    if (hasSuicide && !hasKiller) {
        return {
            score: 0,
            breakdown: [
                '❌ ΕΣΦΑΛΜΕΝΗ ΘΕΩΡΙΑ - ΔΕΝ ΗΤΑΝ ΑΥΤΟΚΤΟΝΙΑ',
                '',
                '🔍 Βασικά Στοιχεία που Αγνοήσατε:',
                '   • Γάντια λάτεξ στην πόρτα (κάποιος προσπάθησε να μην αφήσει αποτυπώματα)',
                '   • Πλαστό email «αυτοκτονίας» από κοινόχρηστο υπολογιστή',
                '   • Απενεργοποίηση κάμερων ακριβώς πριν τη δολοφονία',
                '   • Κυάνιο σε μπουκάλι',
                '',
                '💡 Συμβουλή: Η υπόθεση δολοφονίας που μοιάζει με αυτοκτονία είναι κλασική τακτική συγκάλυψης.',
            ],
            maxScore: 140,
            correctCount: 0
        };
    }

    let correctCount = 0;
    let wrongSuspects = [];
    let missedSuspects = [];
    
    selectedSuspects.forEach(suspect => {
        if (CORRECT_SUSPECTS.includes(suspect)) {
            correctCount++;
        } else {
            wrongSuspects.push(SUSPECT_NAMES[suspect] || suspect);
        }
    });
    
    CORRECT_SUSPECTS.forEach(suspect => {
        if (!selectedSuspects.includes(suspect)) {
            missedSuspects.push(SUSPECT_NAMES[suspect] || suspect);
        }
    });
    
    breakdown.push('🧩 ΒΑΣΙΚΗ ΕΚΤΙΜΗΣΗ');
    breakdown.push('');
    score += SCORING.murder_diagnosis;
    breakdown.push(`✓ Σωστή Διάγνωση: ΔΟΛΟΦΟΝΙΑ (+${SCORING.murder_diagnosis} πόντοι)`);
    breakdown.push('   Αναγνωρίσατε ότι δεν ήταν αυτοκτονία - σωστή εκκίνηση!');
    breakdown.push('');
    breakdown.push('👥 ΤΑΥΤΟΠΟΙΗΣΗ ΔΡΑΣΤΩΝ');
    breakdown.push('');
    
    if (correctCount >= 2) {
        score += SCORING.cooperation;
        breakdown.push(`✓ Εντοπισμός Συνεργασίας (+${SCORING.cooperation} πόντοι)`);
        breakdown.push('   Καταλάβατε ότι ήταν ομαδική προσπάθεια!');
        breakdown.push('');
    }

    if (correctCount === 3 && selectedSuspects.length === 3) {
        score += SCORING.perpetrator * 3;
        score += SCORING.perfect_solution_bonus;
        breakdown.push(`🎖️ ΤΕΛΕΙΑ ΑΝΑΛΥΣΗ! (+${SCORING.perpetrator * 3 + SCORING.perfect_solution_bonus} πόντοι)`);
        breakdown.push('   Εντοπίσατε και τους 3 συνεργούς ΧΩΡΙΣ ψευδή θετικά!');
        breakdown.push('');
        breakdown.push('   ✓ Αναγνώστου (Μαστρομυαλός - έριξε το κυάνιο)');
        breakdown.push('   ✓ Πετρόπουλος (Προμηθευτής - πήρε το κυάνιο, έσβησε κάμερες)');
        breakdown.push('   ✓ Μαυρίδη (Συγκάλυψη - πλαστό email & σημείωμα)');
    } else {
        if (correctCount > 0) {
            const points = correctCount * SCORING.perpetrator;
            score += points;
            breakdown.push(`✓ Εντοπίσατε ${correctCount}/3 Δράστες (+${points} πόντοι)`);
            breakdown.push('');
            selectedSuspects.forEach(suspect => {
                if (CORRECT_SUSPECTS.includes(suspect)) {
                    const name = SUSPECT_NAMES[suspect];
                    let role = '';
                    if (suspect === 'konstantinos') role = 'Μαστρομυαλός της επιχείρησης';
                    else if (suspect === 'georgios') role = 'Προμήθευσε το κυάνιο';
                    else if (suspect === 'eleni') role = 'Συγκάλυψη';
                    breakdown.push(`   ✓ ${name} (${role})`);
                }
            });
        } else {
            breakdown.push(`❌ Δεν εντοπίσατε κανέναν από τους πραγματικούς δράστες (+0 πόντοι)`);
        }
        
        if (correctCount >= 2 && correctCount < 3) {
            score += SCORING.evidence_use;
            breakdown.push('');
            breakdown.push(`✓ Καλή Χρήση Τεκμηρίων (+${SCORING.evidence_use} πόντοι)`);
        }
    }

    if (wrongSuspects.length === 0 && correctCount > 0 && correctCount < 3) {
        const precisionBonus = correctCount * 15;
        score += precisionBonus;
        breakdown.push('');
        breakdown.push(`🎯 Bonus Ακρίβειας (+${precisionBonus} πόντοι)`);
        breakdown.push(`   Όλες οι επιλογές σας ήταν σωστές - απλά χάσατε ${3 - correctCount}`);
    }
    
    breakdown.push('');
    
    if (correctCount >= 2) {
        breakdown.push('⚡ BONUSES ΑΠΟΔΟΤΙΚΟΤΗΤΑΣ');
        breakdown.push('');
        
        let hasBonus = false;
        
        if (totalTimeMs) {
            const minutes = totalTimeMs / 60000;
            if (minutes < 30) {
                score += SCORING.time_under_30;
                breakdown.push(`⏱️ Ταχύτατη Λύση (+${SCORING.time_under_30} πόντοι)`);
                breakdown.push('   Χρόνος: <30 λεπτά');
                hasBonus = true;
            } else if (minutes < 45) {
                score += SCORING.time_30_45;
                breakdown.push(`⏱️ Γρήγορη Λύση (+${SCORING.time_30_45} πόντοι)`);
                breakdown.push('   Χρόνος: 30-45 λεπτά');
                hasBonus = true;
            } else if (minutes < 60) {
                score += SCORING.time_45_60;
                breakdown.push(`⏱️ Καλός Χρόνος (+${SCORING.time_45_60} πόντοι)`);
                breakdown.push('   Χρόνος: 45-60 λεπτά');
                hasBonus = true;
            }
        }

        if (promptCount) {
            if (promptCount <= 5) {
                score += SCORING.prompts_1_5;
                breakdown.push(`🎯 Εξαιρετική Αποδοτικότητα (+${SCORING.prompts_1_5} πόντοι)`);
                breakdown.push('   Prompts: ≤5');
                hasBonus = true;
            } else if (promptCount <= 10) {
                score += SCORING.prompts_6_10;
                breakdown.push(`🎯 Καλή Αποδοτικότητα (+${SCORING.prompts_6_10} πόντοι)`);
                breakdown.push('   Prompts: 6-10');
                hasBonus = true;
            } else if (promptCount <= 15) {
                score += SCORING.prompts_11_15;
                breakdown.push(`🎯 Αξιόλογη Αποδοτικότητα (+${SCORING.prompts_11_15} πόντοι)`);
                breakdown.push('   Prompts: 11-15');
                hasBonus = true;
            }
        }
        
        if (!hasBonus) {
            breakdown.push('(Κανένα bonus αποδοτικότητας)');
        }
        
        breakdown.push('');
    }
    
    if (wrongSuspects.length > 0) {
        breakdown.push(`❌ Κατηγορήσατε Αθώους (${wrongSuspects.length}):`);
        wrongSuspects.forEach(name => {
            breakdown.push(`   → ${name}`);
            if (name === 'Παπαδοπούλου Μαρία') {
                breakdown.push('      • Είχε σιδηρένιο άλλοθι (γιατρός + δείπνο με αδελφή)');
            } else if (name === 'Νικολάου Αλεξάνδρα') {
                breakdown.push('      • Δεν είχε πρόσβαση σε κυάνιο ούτε ισχυρό κίνητρο');
            }
        });
        
        const originalScore = score;
        let multiplier = 1.0;
        if (wrongSuspects.length === 1) {
            multiplier = 0.5;
        } else if (wrongSuspects.length === 2) {
            multiplier = 0.2;
        } else {
            multiplier = 0.05;
        }
        
        score = Math.floor(score * multiplier);
        const penalty = originalScore - score;
        breakdown.push('');
        breakdown.push(`⚖️ Ποινή: -${penalty} πόντοι`);
        breakdown.push('');
    }
        
    if (missedSuspects.length > 0) {
        breakdown.push(`🔍 ΧΑΣΑΤΕ ΠΡΑΓΜΑΤΙΚΟΥΣ ΔΡΑΣΤΕΣ`);
        breakdown.push('');
        const missedPenalty = missedSuspects.length * 20;
        score -= missedPenalty;
        
        missedSuspects.forEach(name => {
            breakdown.push(`   → ${name}`);
            if (name === 'Αναγνώστου Κωνσταντίνος') {
                breakdown.push('      • Τα αποτυπώματά του στο μπουκάλι και το κλειδί');
                breakdown.push('      • Είχε υπεξαίρεση €1.5εκ να κρύψει');
            } else if (name === 'Πετρόπουλος Γεώργιος') {
                breakdown.push('      • Αγόρασε το κυάνιο (απόδειξη ΤΕΚ #9)');
                breakdown.push('      • Απενεργοποίησε κάμερες 20:55');
            } else if (name === 'Μαυρίδη Ελένη') {
                breakdown.push('      • Έστειλε το πλαστό email "αυτοκτονίας"');
                breakdown.push('      • Πλαστογράφησε το χειρόγραφο σημείωμα');
            }
        });
        
        breakdown.push('');
        breakdown.push(`⚖️ Ποινή: -${missedPenalty} πόντοι (Δεν εντοπίσατε ${missedSuspects.length} δράστη${missedSuspects.length > 1 ? 'ς' : ''})`);
    }
    
    breakdown.push('');
    breakdown.push(`🏁 ΤΕΛΙΚΗ ΒΑΘΜΟΛΟΓΙΑ: ${score}/${140}`);
    score = Math.max(0, Math.min(score, 140));
    return { score, breakdown, maxScore: 140, correctCount, wrongCount: wrongSuspects.length };
}

async function submitSolution() {
    const checkboxes = document.querySelectorAll('input[name="suspect"]:checked');
    const selectedSuspects = Array.from(checkboxes).map(cb => cb.value);
    const justification = document.getElementById('justification').value.trim();
    const promptCount = parseInt(document.getElementById('promptCount').value) || 0;

    if (selectedSuspects.length === 0) {
        alert('Παρακαλώ επιλέξτε τουλάχιστον έναν ύποπτο ή αυτοκτονία!');
        return;
    }

    if (!justification || justification.length < 50) {
        alert('Παρακαλώ συμπληρώστε αναλυτική αιτιολόγηση (τουλάχιστον 50 χαρακτήρες)!');
        return;
    }

    if (promptCount === null || promptCount === undefined || promptCount < 0) {
        alert('Παρακαλώ εισάγετε έγκυρο αριθμό prompts!');
        return;
    }
    
    const teamData = await getTeamData();
    if (teamData.unlocked.length < 6) {
        alert(`Πρέπει να ξεκλειδώσετε τουλάχιστον 6 τεκμήρια πριν υποβάλετε λύση! (Έχετε: ${teamData.unlocked.length}/11)`);
        return;
    }

    if (teamData.solution) {
        alert('Έχετε ήδη υποβάλει λύση! Δεν μπορείτε να υποβάλετε ξανά.');
        return;
    }            
    
    let totalTimeMs = null;
    if (teamData.startTime) {
        const start = new Date(teamData.startTime);
        const now = new Date();
        totalTimeMs = now - start;
    }

    const scoreResult = calculateScore(selectedSuspects, totalTimeMs, promptCount);

    const solution = {
        suspects: selectedSuspects,
        justification: justification,
        justificationLength: justification.length,
        promptCount: promptCount,
        submittedAt: new Date().toISOString(),
        completionTimeMs: totalTimeMs,
        score: scoreResult.score,
        maxScore: scoreResult.maxScore,
        breakdown: scoreResult.breakdown,
        correctCount: scoreResult.correctCount,
        researchData: {
            evidenceUnlockSequence: Object.keys(teamData.evidenceTimestamps || {}).sort((a, b) => {
                return new Date(teamData.evidenceTimestamps[a]) - new Date(teamData.evidenceTimestamps[b]);
            }),
            totalEvidenceUnlocked: (teamData.unlocked || []).length,
            firstEvidenceTime: teamData.startTime || null,
            lastEvidenceTime: (teamData.evidenceTimestamps && Object.keys(teamData.evidenceTimestamps).length > 0) ? 
                Object.values(teamData.evidenceTimestamps).sort().pop() : null,
            timeSpentMinutes: totalTimeMs ? Math.round(totalTimeMs / 60000) : null,
            strategy: selectedSuspects.includes('suicide') ? 'suicide' : 
                     (selectedSuspects.length === 5 ? 'shotgun' : 
                     (selectedSuspects.length === 3 ? 'selective' : 'selective'))
        }
    };
    
    try {
        const updatedData = {
            ...teamData,
            solution: solution,
            completedAt: solution.submittedAt,
            totalTimeMs: totalTimeMs,
            lastUpdate: new Date().toISOString()
        };
        
        localStorage.setItem(getStorageKey(), JSON.stringify(updatedData));
        
        if (window.firebaseDB) {
            await window.firebaseSetDoc(
                window.firebaseDoc(window.firebaseDB, 'teams', teamCode),
                updatedData
            );
        }
        
        localStorage.setItem(`solution_${teamCode}`, JSON.stringify(solution));
        displaySubmissionConfirmation();
        
    } catch (error) {
        console.error('Error saving solution:', error);
        alert('Σφάλμα αποθήκευσης! Δοκιμάστε ξανά.');
    }
}

function displaySubmissionConfirmation() {
    const resultDiv = document.getElementById('solutionResult');
    const solutionIntroBox = document.getElementById('solutionIntroBox');
    if (solutionIntroBox) {
        solutionIntroBox.style.display = 'none';
    }
    
    resultDiv.innerHTML = `
        <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px 30px; border-radius: 12px; margin: 20px 0; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(40,167,69,0.3); flex-wrap: wrap; gap: 15px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 40px;"></div>
                <div>
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">ΛΥΣΗ ΥΠΟΒΛΗΘΗΚΕ ΕΠΙΤΥΧΩΣ!</div>
                    <div style="font-size: 14px; opacity: 0.9;">📅 ${new Date().toLocaleString('el-GR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</div>
                </div>
            </div>
        </div>

        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 3px solid #ff6b00; padding: 0; border-radius: 15px; margin-top: 20px; box-shadow: 0 10px 40px rgba(255, 107, 0, 0.4); overflow: hidden;">
            <div style="background: linear-gradient(135deg, #ff6b00 0%, #ff8800 100%); padding: 25px; text-align: center; position: relative;">
                <div style="font-size: 56px; margin-bottom: 10px; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">🔒</div>
                <h3 style="color: #000; font-size: 24px; font-weight: bold; margin: 0; text-transform: uppercase; letter-spacing: 2px; text-shadow: 1px 1px 2px rgba(255,255,255,0.3);">
                    Η ΑΛΗΘΕΙΑ ΘΑ ΑΠΟΚΑΛΥΦΘΕΙ ΣΥΝΤΟΜΑ...
                </h3>
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 100%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px); pointer-events: none;"></div>
            </div>
            <div style="padding: 30px;">
                <div style="background: linear-gradient(135deg, rgba(255, 107, 0, 0.2) 0%, rgba(255, 136, 0, 0.2) 100%); border: 2px solid #ff6b00; border-radius: 12px; padding: 20px; margin-bottom: 30px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; font-size: 100px; opacity: 0.1;">⚠️</div>
                    <div style="position: relative; z-index: 1;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 28px;">💡</span>
                            <span style="color: #ff6b00; font-size: 16px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">ΠΡΟΣΟΧΗ!</span>
                        </div>
                        <p style="color: #fff; font-size: 14px; margin: 0; text-align: center; line-height: 1.7; font-weight: 600;">
                            ΚΡΑΤΗΣΤΕ ΤΗ ΛΥΣΗ ΣΑΣ ΜΥΣΤΙΚΗ!<br>
                            ΜΗΝ ΜΟΙΡΑΣΤΕΙΤΕ ΠΛΗΡΟΦΟΡΙΕΣ ΜΕ ΑΛΛΕΣ ΟΜΑΔΕΣ ΜΕΧΡΙ ΤΗΝ ΕΠΙΣΗΜΗ ΛΗΞΗ ΤΟΥ ΔΙΑΓΩΝΙΣΜΟΥ!
                        </p>
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 25px; backdrop-filter: blur(5px);">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="display: inline-flex; align-items: center; gap: 10px; background: rgba(255, 107, 0, 0.2); padding: 10px 20px; border-radius: 25px; border: 1px solid rgba(255, 107, 0, 0.4);">
                            <span style="font-size: 20px;">🔓</span>
                            <span style="color: #ff6b00; font-weight: bold; font-size: 15px; text-transform: uppercase; letter-spacing: 1px;">Έχετε τον κωδικό πρόσβασης;</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: stretch; max-width: 500px; margin: 0 auto;">
                        <input type="password" id="solutionPassword" placeholder="Εισάγετε κωδικό..." 
                               style="flex: 1; min-width: 200px; padding: 15px 20px; border: 2px solid rgba(255, 107, 0, 0.5); background: rgba(255, 255, 255, 0.9); border-radius: 10px; font-size: 16px; font-weight: 500; transition: all 0.3s ease; outline: none; color: #1a1a2e;"
                               onfocus="this.style.borderColor='#ff6b00'; this.style.background='#fff'; this.style.boxShadow='0 0 20px rgba(255, 107, 0, 0.3)'"
                               onblur="this.style.borderColor='rgba(255, 107, 0, 0.5)'; this.style.background='rgba(255, 255, 255, 0.9)'; this.style.boxShadow='none'">
                        <button onclick="revealSolution()" 
                                style="padding: 15px 35px; background: linear-gradient(135deg, #ff6b00 0%, #ff8800 100%); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 15px rgba(255, 107, 0, 0.4); transition: all 0.3s ease; white-space: nowrap; text-transform: uppercase; letter-spacing: 1px;"
                                onmouseover="this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 6px 25px rgba(255, 107, 0, 0.6)'"
                                onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 0, 0.4)'">
                            🔓 ΑΠΟΚΑΛΥΨΗ
                        </button>
                    </div>
                    
                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px; text-align: center; margin: 15px 0 0 0; font-style: italic;">
                        Ο κωδικός θα ανακοινωθεί από τους διοργανωτές
                    </p>
                </div>
            </div>
        </div>
    `;
    
    resultDiv.style.display = 'block';
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    const solutionForm = document.getElementById('solutionForm');
    if (solutionForm) {
        solutionForm.style.display = 'none';
    }
    
    stopTimer();
}

function displaySolutionResult(solution) {
    const resultDiv = document.getElementById('solutionResult');
    const solutionIntroBox = document.getElementById('solutionIntroBox');
    if (solutionIntroBox) {
        solutionIntroBox.style.display = 'none';
    }
    const percentage = Math.round((solution.score / solution.maxScore) * 100);
    let grade = '';
    let gradeColor = '';
    if (percentage >= 90) {
        grade = 'ΑΡΧΙ-ΝΤΕΤΕΚΤΙΒΣ 🕵️';
        gradeColor = '#00d4ff';
    } else if (percentage >= 80) {
        grade = 'ΑΝΩΤΕΡΟΙ ΑΝΑΚΡΙΤΕΣ 🎖️';
        gradeColor = '#ffd700';
    } else if (percentage >= 70) {
        grade = 'ΝΤΕΤΕΚΤΙΒΣ 🔎';
        gradeColor = '#c0c0c0';
    } else if (percentage >= 60) {
        grade = 'ΑΣΤΥΝΟΜΟΙ 👮';
        gradeColor = '#cd7f32';
    } else if (percentage >= 50) {
        grade = 'ΕΡΕΥΝΗΤΕΣ 🔍';
        gradeColor = '#ffcc00';
    } else if (percentage >= 40) {
        grade = 'ΑΣΚΟΥΜΕΝΟΙ 🎓';
        gradeColor = '#28a745';
    } else {
        grade = 'ΝΕΟΣΥΛΛΕΚΤΟΙ 🎯';
        gradeColor = '#6c757d';
    }

    const isPerfect = solution.correctCount === 3 && solution.suspects.length === 3;
    const hasSuicide = solution.suspects.includes('suicide');
    const hasKiller = solution.suspects.some(s => s !== 'suicide');
    const isContradiction = hasSuicide && hasKiller;
    let headerGradient = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
    let headerShadow = 'rgba(40,167,69,0.3)';
    
    if (isContradiction || solution.score === 0) {
        headerGradient = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
        headerShadow = 'rgba(220,53,69,0.3)';
    } else if (percentage < 50) {
        headerGradient = 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)';
        headerShadow = 'rgba(255,193,7,0.3)';
    }

    let statsHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">';
    
    statsHTML += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.3);">';
    statsHTML += '<div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">ΠΟΣΟΣΤΟ</div>';
    statsHTML += '<div style="font-size: 24px; font-weight: bold;">' + percentage + '%</div>';
    statsHTML += '</div>';
    
    if (solution.completionTimeMs) {
        statsHTML += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.3);">';
        statsHTML += '<div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">⏱️ ΧΡΟΝΟΣ</div>';
        statsHTML += '<div style="font-size: 24px; font-weight: bold;">' + formatElapsedTime(solution.completionTimeMs) + '</div>';
        statsHTML += '</div>';
    }
    
    statsHTML += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.3);">';
    statsHTML += '<div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">🎯 PROMPTS</div>';
    statsHTML += '<div style="font-size: 24px; font-weight: bold;">' + solution.promptCount + '</div>';
    statsHTML += '</div>';
    statsHTML += '</div>';

    const breakdownHTML = solution.breakdown.map(function(item) {
        if (item.trim() === '') {
            return '<div style="height: 8px;"></div>';
        }

        if (item.includes('═')) {
            return '<hr style="border: none; border-top: 2px solid #ff6b00; margin: 15px 0; opacity: 0.3;">';
        }

        if (item.match(/^[🎯🧩👥⚡⚠️🔍❌]/)) {
            return '<div style="background: linear-gradient(135deg, #0f3460 0%, #16213e 100%); color: white; padding: 12px 15px; margin: 20px 0 10px 0; border-radius: 8px; font-weight: bold; font-size: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">' + item + '</div>';
        }

        if (item.startsWith('   •') || item.startsWith('   →')) {
            return '<div style="padding: 6px 6px 6px 35px; margin: 3px 0; color: #555; font-size: 13px; line-height: 1.6;">' + item + '</div>';
        }

        if (item.startsWith('   ')) {
            return '<div style="padding: 5px 5px 5px 30px; margin: 2px 0; color: #666; font-size: 13px;">' + item + '</div>';
        }

        var bgColor = 'transparent';
        var borderColor = 'transparent';
        var textColor = '#333';
        var fontWeight = 'normal';
        var padding = '8px 12px';
        var hasBorder = false;

        if (item.includes('🚫') || item.includes('❌')) {
            bgColor = '#fff5f5';
            borderColor = '#dc3545';
            textColor = '#721c24';
            fontWeight = 'bold';
            hasBorder = true;
        } else if (item.includes('✓') || item.includes('🎖️')) {
            bgColor = '#f0fff4';
            borderColor = '#28a745';
            textColor = '#155724';
            hasBorder = true;
        } else if (item.includes('⚖️') || item.includes('📉')) {
            bgColor = '#fff8e1';
            borderColor = '#ff9800';
            textColor = '#e65100';
            hasBorder = true;
        } else if (item.includes('💡')) {
            bgColor = '#e3f2fd';
            borderColor = '#2196f3';
            textColor = '#0d47a1';
            hasBorder = true;
        }

        var borderStyle = hasBorder ? 'border-left: 4px solid ' + borderColor + ';' : '';
        return '<div style="padding: ' + padding + '; margin: 5px 0; background: ' + bgColor + '; ' + borderStyle + ' border-radius: 4px; color: ' + textColor + '; font-weight: ' + fontWeight + '; line-height: 1.6;">' + item + '</div>';
    }).join('');

    resultDiv.innerHTML = 
        '<div style="background: ' + headerGradient + '; color: white; padding: 30px; border-radius: 15px; margin: 20px 0; text-align: center; box-shadow: 0 10px 40px ' + headerShadow + ';">' +
        '<h2 style="font-size: 32px; margin-bottom: 15px;">' +
        (isPerfect ? '🎉 ΤΕΛΕΙΑ ΛΥΣΗ!' : isContradiction ? '❌ ΛΟΓΙΚΗ ΑΝΤΙΦΑΣΗ' : solution.score === 0 ? '❌ ΛΑΘΟΣ ΑΠΑΝΤΗΣΗ' : 'ΑΠΟΤΕΛΕΣΜΑΤΑ ΕΡΕΥΝΑΣ') +
        '</h2>' +
        '<div style="font-size: 64px; font-weight: bold; margin: 20px 0;">' + solution.score + '/' + solution.maxScore + '</div>' +
        '<div style="font-size: 28px; margin-bottom: 20px; color: ' + gradeColor + '; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">' + grade + '</div>' +
        statsHTML +
        '</div>' +
        '<div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #28a745;">' +
        '<h4 style="color: #1a1a2e; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #ff6b00; padding-bottom: 8px;">📊 ΑΝΑΛΥΣΗ ΤΗΣ ΒΑΘΜΟΛΟΓΙΑΣ ΣΑΣ</h4>' +
        '<div style="font-family: \'Courier New\', monospace; line-height: 1.8; font-size: 14px;">' +
        breakdownHTML +
        '</div>' +
        '</div>';
    
    resultDiv.style.display = 'block';
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    const solutionForm = document.getElementById('solutionForm');
    if (solutionForm) {
        solutionForm.style.display = 'none';
    }
    
    stopTimer();
}

window.revealSolution = async function() {
    const password = document.getElementById('solutionPassword').value.toUpperCase();
    const correctPassword = 'MURDER';
    
    if (password !== correctPassword) {
        alert('❌ Λάθος κωδικός! Ζητήστε τον σωστό κωδικό από τον οργανωτή.');
        document.getElementById('solutionPassword').value = '';
        return;
    }
    
    const teamData = await getTeamData();
    const solution = teamData.solution;
    
    if (!solution) {
        alert('Δεν βρέθηκε υποβληθείσα λύση!');
        return;
    }

    const scoreResult = calculateScore(
        solution.suspects, 
        solution.completionTimeMs, 
        solution.promptCount
    );

    const completeSolution = {
        ...solution,
        score: scoreResult.score,
        maxScore: scoreResult.maxScore,
        breakdown: scoreResult.breakdown,
        correctCount: scoreResult.correctCount,
        wrongCount: solution.suspects.length - scoreResult.correctCount
    };
    
    const submissionHeader = document.getElementById('submissionHeader');
    const passwordSection = document.getElementById('passwordSection');
    if (submissionHeader) submissionHeader.style.display = 'none';
    if (passwordSection) passwordSection.style.display = 'none';

    displaySolutionResult(completeSolution);
};

function buildUrl(page) {
    return teamCode !== 'default' ? `${page}?team=${teamCode}` : page;
}

function renderEvidence() {
    const unlockedTeks = getUnlockedTeks();
    const grid = document.getElementById('evidenceGrid');
    
    grid.innerHTML = teks.map(tek => {
        const isUnlocked = unlockedTeks.includes(tek.id);
        const cardClass = isUnlocked ? 'unlocked' : 'locked';
        
        let criticalTag = '';
        if (tek.critical) criticalTag = '<span class="critical-tag">ΚΡΙΣΙΜΟ</span>';
        else if (tek.secret) criticalTag = '<span class="critical-tag">ΑΠΟΡΡΗΤΟ</span>';
        else if (tek.blackmail) criticalTag = '<span class="critical-tag">ΕΚΒΙΑΣΜΟΣ</span>';
        else if (tek.sabotage) criticalTag = '<span class="critical-tag">ΣΑΜΠΟΤΑΖ</span>';
        else if (tek.threat) criticalTag = '<span class="critical-tag">ΑΠΕΙΛΗ</span>';
        else if (tek.forgery) criticalTag = '<span class="critical-tag">ΠΛΑΣΤΟΓΡΑΦΙΑ</span>';
        else if (tek.clue) criticalTag = '<span class="critical-tag">ΕΝΔΕΙΞΗ</span>';
        else if (tek.financial) criticalTag = '<span class="critical-tag">ΟΙΚΟΝΟΜΙΚΟ</span>';
        
        return `
            <div class="evidence-card ${cardClass}">
                ${criticalTag}
                ${!isUnlocked ? '<div class="lock-overlay">🔒</div>' : ''}
                <div class="evidence-header">
                    <div class="evidence-icon">${tek.icon}</div>
                    <div class="evidence-info">
                        <h3>ΤΕΚ #${tek.id.padStart(3, '0')}</h3>
                        <p>${tek.subtitle}</p>
                    </div>
                </div>
				<p class="evidence-description">
					${isUnlocked ? tek.description : ''}
				</p>
                <div class="evidence-actions">
					${isUnlocked ? 
						`<a href="${buildUrl(tek.page)}" class="btn btn-ar">
							👀️ Προβολή Τεκμηρίου
						</a>` :
						`<button class="btn btn-ar" disabled></button>`
					}
                </div>
                <span class="status-badge ${isUnlocked ? 'status-unlocked' : 'status-locked'}">
                    ${isUnlocked ? '✅ ΔΙΑΘΕΣΙΜΟ' : '🔒 ΚΛΕΙΔΩΜΕΝΟ'}
                </span>
            </div>
        `;
    }).join('');
}

async function initSolutionTab(teamData) {
    const solutionIntroBox = document.getElementById('solutionIntroBox');
    const solutionForm = document.getElementById('solutionForm');
    const existingSolution = teamData.solution;
    
    if (existingSolution) {
        if (solutionIntroBox) {
            solutionIntroBox.style.display = 'none';
        }
        if (solutionForm) {
            solutionForm.style.display = 'none';
        }
        
        displaySubmissionConfirmation();
    }
}

window.addEventListener('storage', async (e) => {
    if (e.key === getStorageKey() || e.key === `solution_${teamCode}`) {
        console.log('🔄 Storage change detected, updating UI...');
        renderEvidence();
        const teamData = await getTeamData();
        await updateProgress(teamData);
        const solutionTab = document.getElementById('tab-solution');
        if (solutionTab && solutionTab.classList.contains('active')) {
            await initSolutionTab(teamData);
        }
    }
});

window.submitSolution = submitSolution;

function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');

            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(`tab-${targetTab}`).classList.add('active');
        });
    });
}

window.submitSolution = submitSolution;
window.switchToSurveyTab = switchToSurveyTab;

let resultsUnsubscribe = null;
let alertsUnsubscribe = null;

function switchToSurveyTab() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');
    
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabPanes.forEach(pane => pane.classList.remove('active'));
    
    document.querySelector('[data-tab="survey"]').classList.add('active');
    document.getElementById('tab-survey').classList.add('active');
}

async function checkSurveyCompletion() {
    if (!window.firebaseDB) {
        console.warn('Firebase not ready for survey check');
        return { 
            pre: false, 
            post: false, 
            preCount: 0, 
            postCount: 0, 
            bothCount: 0,
            teamSize: 0,
            members: [] 
        };
    }

    try {
        const teamDocRef = window.firebaseDoc(window.firebaseDB, 'teams', teamCode);
        const teamDoc = await window.firebaseGetDoc(teamDocRef);
        const teamSize = teamDoc.exists() ? (teamDoc.data().teamSize || 0) : 0;
        
        if (teamSize === 0) {
            console.warn(`Team ${teamCode} has no teamSize configured. Please set teamSize in Firebase.`);
        }
        
        const surveysRef = window.firebaseCollection(window.firebaseDB, 'surveys');
        const querySnapshot = await window.firebaseGetDocs(surveysRef);
        
        const preMembers = new Set();
        const postMembers = new Set();
        const membersWithBoth = new Set();
        querySnapshot.forEach((doc) => {
            const docId = doc.id;
            if (docId.startsWith(`${teamCode}_pre_`)) {
                const memberName = docId.replace(`${teamCode}_pre_`, '');
                preMembers.add(memberName);
            }
            
            if (docId.startsWith(`${teamCode}_post_`)) {
                const memberName = docId.replace(`${teamCode}_post_`, '');
                postMembers.add(memberName);
            }
        });

        preMembers.forEach(member => {
            if (postMembers.has(member)) {
                membersWithBoth.add(member);
            }
        });
        
        const bothCount = membersWithBoth.size;
        const meetsRequirement = teamSize > 0 && bothCount >= teamSize;
        
        console.log(`Survey check for ${teamCode}:`);
        console.log(`  Team size: ${teamSize}`);
        console.log(`  Members completed both: ${bothCount}/${teamSize}`);
        console.log(`  Pre-survey: ${preMembers.size}, Post-survey: ${postMembers.size}`);
        console.log(`  Requirement met: ${meetsRequirement}`);
        
        return {
            pre: meetsRequirement,
            post: meetsRequirement,
            preCount: preMembers.size,
            postCount: postMembers.size,
            bothCount: bothCount,
            teamSize: teamSize,
            members: Array.from(membersWithBoth)
        };
    } catch (error) {
        console.error('Error checking surveys:', error);
        return { 
            pre: false, 
            post: false, 
            preCount: 0, 
            postCount: 0, 
            bothCount: 0,
            teamSize: 0,
            members: [] 
        };
    }
}

async function checkLeaderboardUnlocked() {
    if (!window.firebaseDB) return false;
    
    try {
        const docRef = window.firebaseDoc(window.firebaseDB, 'config', 'leaderboard');
        const docSnap = await window.firebaseGetDoc(docRef);
        
        return docSnap.exists() ? (docSnap.data().unlocked || false) : false;
    } catch (error) {
        console.error('Error checking leaderboard status:', error);
        return false;
    }
}

async function updateResultsTabState() {
    const { teamCode, memberName } = StorageManager.getAuth();
    
    if (!memberName || !teamCode || teamCode === 'default') {
        console.error('Member or team info missing!');
        const surveysIncomplete = document.getElementById('surveysIncomplete');
        if (surveysIncomplete) {
            surveysIncomplete.innerHTML = `
                <div class="intro-box" style="text-align: center; padding: 60px 30px;">
                    <div style="font-size: clamp(80px, 20vw, 120px); margin-bottom: 30px;">🔐</div>
                    <h2 style="color: #1a1a2e; font-size: clamp(20px, 5vw, 28px); margin-bottom: 20px;">
                        Απαιτείται Σύνδεση
                    </h2>
                    <a href="team_member_entry.html" 
                       class="btn btn-primary" 
                       style="display: inline-block; text-decoration: none;">
                        🔐 ΣΥΝΔΕΣΗ
                    </a>
                </div>
            `;
            surveysIncomplete.style.display = 'block';
        }
        return;
    }
    const postSurveyDoc = `${teamCode}_post_${memberName}`;
    const postSurveyRef = window.firebaseDoc(window.firebaseDB, 'surveys', postSurveyDoc);
    const postSurveySnap = await window.firebaseGetDoc(postSurveyRef);
    const memberCompletedPost = postSurveySnap.exists();
    const surveys = await checkSurveyCompletion();
    const leaderboardUnlocked = await checkLeaderboardUnlocked();
    const surveysIncomplete = document.getElementById('surveysIncomplete');
    const leaderboardLocked = document.getElementById('leaderboardLocked');
    const leaderboardUnlockedDiv = document.getElementById('leaderboardUnlocked');

    if (!memberCompletedPost) {
        surveysIncomplete.innerHTML = `
            <div class="intro-box" style="text-align: center; padding: 60px 30px;">
                <div style="font-size: clamp(80px, 20vw, 120px); margin-bottom: 30px;">🔐</div>
                <h2 style="color: #1a1a2e; font-size: clamp(20px, 5vw, 28px); margin-bottom: 20px;">
                    Ολοκληρώστε Πρώτα την Τελική Έρευνα
                </h2>
                <a href="survey.html?team=${teamCode}&member=${encodeURIComponent(memberName)}" 
                   class="btn btn-primary" 
                   style="display: inline-block; text-decoration: none; font-size: clamp(16px, 3.5vw, 18px); padding: clamp(15px, 3vw, 18px) clamp(30px, 6vw, 40px);">
                    📊 ΜΕΤΑΒΑΣΗ ΣΤΗΝ ΤΕΛΙΚΗ ΕΡΕΥΝΑ
                </a>
            </div>
        `;
        surveysIncomplete.style.display = 'block';
        leaderboardLocked.style.display = 'none';
        leaderboardUnlockedDiv.style.display = 'none';
        return;
    }
    const preSurveyStatus = document.getElementById('preSurveyStatus');
    const postSurveyStatus = document.getElementById('postSurveyStatus');
    
    if (preSurveyStatus) {
        if (surveys.teamSize === 0) {
            preSurveyStatus.innerHTML = '⚠️ <strong>ΠΡΟΚΑΤΑΡΚΤΙΚΗ ΕΡΕΥΝΑ:</strong> ΜΕΓΕΘΟΣ ΟΜΑΔΑΣ ΔΕΝ ΕΧΕΙ ΟΡΙΣΤΕΙ';
        } else if (surveys.bothCount >= surveys.teamSize) {
            preSurveyStatus.innerHTML = `✅ <strong>ΠΡΟΚΑΤΑΡΚΤΙΚΗ ΕΡΕΥΝΑ:</strong> ΟΛΑ ΤΑ ΜΕΛΗ (${surveys.preCount}/${surveys.teamSize}) ΤΗΝ ΟΛΟΚΛΗΡΩΣΑΝ`;
        } else {
            preSurveyStatus.innerHTML = `⏳ <strong>ΠΡΟΚΑΤΑΡΚΤΙΚΗ ΕΡΕΥΝΑ:</strong> ${surveys.preCount}/${surveys.teamSize} ΜΕΛΗ ΤΗΝ ΟΛΟΚΛΗΡΩΣΑΝ`;
        }
    }
    
    if (postSurveyStatus) {
        if (surveys.teamSize === 0) {
            postSurveyStatus.innerHTML = '⚠️ <strong>ΤΕΛΙΚΗ ΕΡΕΥΝΑ:</strong> ΜΕΓΕΘΟΣ ΟΜΑΔΑΣ ΔΕΝ ΕΧΕΙ ΟΡΙΣΤΕΙ';
        } else if (surveys.bothCount >= surveys.teamSize) {
            postSurveyStatus.innerHTML = `✅ <strong>ΤΕΛΙΚΗ ΕΡΕΥΝΑ:</strong> ΟΛΑ ΤΑ ΜΕΛΗ (${surveys.postCount}/${surveys.teamSize}) ΤΗΝ ΟΛΟΚΛΗΡΩΣΑΝ`;
        } else {
            postSurveyStatus.innerHTML = `⏳ <strong>ΤΕΛΙΚΗ ΕΡΕΥΝΑ:</strong> ${surveys.postCount}/${surveys.teamSize} ΜΕΛΗ ΤΗΝ ΟΛΟΚΛΗΡΩΣΑΝ`;
        }
    }
    
    if (!surveys.pre || !surveys.post) {
        surveysIncomplete.style.display = 'block';
        leaderboardLocked.style.display = 'none';
        leaderboardUnlockedDiv.style.display = 'none';
    } else if (!leaderboardUnlocked) {
        surveysIncomplete.style.display = 'none';
        leaderboardLocked.style.display = 'block';
        leaderboardUnlockedDiv.style.display = 'none';
    } else {
        surveysIncomplete.style.display = 'none';
        leaderboardLocked.style.display = 'none';
        leaderboardUnlockedDiv.style.display = 'block';
        await loadLeaderboardData();
    }
}

function getResultsGrade(percentage) {
    if (percentage >= 90) return { name: 'ΑΡΧΙ-ΝΤΕΤΕΚΤΙΒΑΣ 🕵️', color: '#00d4ff' };
    if (percentage >= 80) return { name: 'ΑΝΩΤΕΡΟΙ ΑΝΑΚΡΙΤΕΣ 🎖️', color: '#ffd700' };
    if (percentage >= 70) return { name: 'ΝΤΕΤΕΚΤΙΒΑΣ 🔎', color: '#c0c0c0' };
    if (percentage >= 60) return { name: 'ΑΣΤΥΝΟΜΟΙ 👮', color: '#cd7f32' };
    if (percentage >= 50) return { name: 'ΕΡΕΥΝΗΤΕΣ 📋', color: '#ffcc00' };
    if (percentage >= 40) return { name: 'ΑΣΚΟΥΜΕΝΟΙ 🎓', color: '#28a745' };
    return { name: 'ΝΕΟΣΥΛΛΕΚΤΟΙ 🎯', color: '#6c757d' };
}

async function loadLeaderboardData() {
    try {
        console.log('📊 Loading leaderboard data...');
        
        if (!window.firebaseDB) {
            console.error('Firebase not ready!');
            displayLeaderboardError('Σύνδεση με τη βάση δεδομένων απέτυχε');
            return;
        }
        
        const querySnapshot = await window.firebaseGetDocs(
            window.firebaseCollection(window.firebaseDB, 'teams')
        );
        
        console.log(`Found ${querySnapshot.size} teams in database`);
        
        const teams = [];
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            console.log(`Team ${doc.id}:`, {
                hasSolution: !!data.solution,
                score: data.solution?.score,
                unlocked: data.unlocked?.length
            });
            
            if (data.solution) {
                teams.push({
                    name: doc.id,
                    ...data
                });
            }
        });

        console.log(`${teams.length} teams have submitted solutions`);

        if (teams.length === 0) {
            displayLeaderboardError('Δεν υπάρχουν ομάδες που έχουν υποβάλει λύση ακόμα!');
            return;
        }

        teams.sort((a, b) => b.solution.score - a.solution.score);

        displayResultsStats(teams);
        displayResultsLeaderboard(teams);

    } catch (error) {
        console.error('Error loading leaderboard:', error);
        displayLeaderboardError(`Σφάλμα φόρτωσης: ${error.message}`);
    }
}

function displayLeaderboardError(message) {
    const tableBody = document.getElementById('resultsTableBody');
    const cardsContainer = document.getElementById('resultsCards');
    
    const errorHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 60px; margin-bottom: 20px;">⚠️</div>
            <div style="color: #dc3545; font-weight: bold; margin-bottom: 15px; white-space: pre-line;">
                ${message}
            </div>
            <button onclick="loadLeaderboardData()" style="margin-top: 20px; padding: 12px 24px; background: #ff6b00; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                🔄 Δοκιμάστε Ξανά
            </button>
        </div>
    `;
    
    if (tableBody) {
        tableBody.innerHTML = `<tr><td colspan="5">${errorHTML}</td></tr>`;
    }
    
    if (cardsContainer) {
        cardsContainer.innerHTML = errorHTML;
    }
}

function formatTime(ms) {
    if (!ms) return 'N/A';
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    const h = hours;
    const m = minutes % 60;
    const s = seconds % 60;
    
    if (h > 0) return `${h}ω ${m}λ ${s}δ`;
    else if (m > 0) return `${m}λ ${s}δ`;
    else return `${s}δ`;
}

function displayResultsStats(teams) {
    const totalTeams = teams.length;
    const perfectScores = teams.filter(t => {
        const suspects = t.solution.suspects || [];
        return suspects.length === 3 && 
               suspects.includes('konstantinos') && 
               suspects.includes('georgios') && 
               suspects.includes('eleni');
    }).length;
    
    const avgScore = totalTeams > 0 
        ? Math.round(teams.reduce((sum, t) => sum + t.solution.score, 0) / totalTeams)
        : 0;
    
    const avgTime = totalTeams > 0
        ? formatTime(teams.reduce((sum, t) => sum + (t.solution.completionTimeMs || 0), 0) / totalTeams)
        : 'N/A';

    document.getElementById('totalTeams').textContent = totalTeams;
    document.getElementById('perfectScores').textContent = perfectScores;
    document.getElementById('avgScore').textContent = avgScore;
    document.getElementById('avgTime').textContent = avgTime;
}

function displayResultsLeaderboard(teams) {
    const tableBody = document.getElementById('resultsTableBody');
    const cardsContainer = document.getElementById('resultsCards');
    const table = document.getElementById('resultsTable');
    const cards = document.getElementById('resultsCards');
    
    if (!tableBody || !cardsContainer || !table || !cards) {
        console.error('Leaderboard elements not found in DOM!');
        return;
    }
    
    if (teams.length === 0) {
        displayLeaderboardError('Δεν υπάρχουν υποβολές ακόμα');
        return;
    }

    if (window.innerWidth > 768) {
        table.style.display = 'table';
        cards.style.display = 'none';
    } else {
        table.style.display = 'none';
        cards.style.display = 'block';
    }

    tableBody.innerHTML = teams.map((team, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        const solution = team.solution;
        
        const maxScore = solution.maxScore || 140;
        const percentage = Math.round((solution.score / maxScore) * 100);
        const grade = getResultsGrade(percentage);
        const rankEmoji = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : rank;

        const isCurrentTeam = team.name === teamCode;
        const rowStyle = isCurrentTeam ? 'background: #fff3cd; font-weight: bold;' : '';

        return `
            <tr style="${rowStyle}">
                <td class="rank ${rankClass}" style="padding: 12px 10px; font-size: clamp(18px, 4vw, 24px); font-weight: bold; text-align: center;">
                    ${rankEmoji}
                </td>
                <td style="padding: 12px 10px; font-weight: bold; color: #1a1a2e; text-transform: uppercase;">
                    ${team.name.toUpperCase()}
                </td>
                <td style="padding: 12px 10px; font-weight: bold; color: #28a745;">
                    ${solution.score}/${maxScore}
                </td>
                <td style="padding: 12px 10px;">
                    <span style="display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: clamp(10px, 2vw, 12px); font-weight: bold; background: ${grade.color}; color: ${percentage >= 50 ? '#000' : '#fff'};">
                        ${grade.name}
                    </span>
                </td>
                <td style="padding: 12px 10px;">
                    ${formatTime(solution.completionTimeMs)}
                </td>
            </tr>
        `;
    }).join('');

    cardsContainer.innerHTML = teams.map((team, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        const solution = team.solution;
        
        const maxScore = solution.maxScore || 140;
        const percentage = Math.round((solution.score / maxScore) * 100);
        const grade = getResultsGrade(percentage);
        const rankEmoji = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`;

        const isCurrentTeam = team.name === teamCode;
        const cardStyle = isCurrentTeam ? 'border: 3px solid #ffc107; box-shadow: 0 5px 25px rgba(255,193,7,0.4);' : '';

        return `
            <div style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 15px; ${cardStyle}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                    <div class="${rankClass}" style="font-size: 36px; font-weight: bold;">${rankEmoji}</div>
                    <div style="font-size: 18px; font-weight: bold; color: #1a1a2e; text-transform: uppercase; flex: 1; margin: 0 15px;">
                        ${team.name.toUpperCase()}
                    </div>
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">
                        ${solution.score}/${maxScore}
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f5f5f5;">
                    <div style="font-weight: bold; color: #666; font-size: 13px;">ΤΙΤΛΟΣ</div>
                    <div>
                        <span style="display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 10px; font-weight: bold; background: ${grade.color}; color: ${percentage >= 50 ? '#000' : '#fff'};">
                            ${grade.name}
                        </span>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                    <div style="font-weight: bold; color: #666; font-size: 13px;">ΧΡΟΝΟΣ</div>
                    <div style="color: #333;">${formatTime(solution.completionTimeMs)}</div>
                </div>
            </div>
        `;
    }).join('');
    
    console.log('✅ Leaderboard displayed successfully');
}

function setupResultsListener() {
    if (!window.firebaseDB) {
        console.warn('Firebase not ready for results listener');
        setTimeout(setupResultsListener, 500);
        return;
    }

    try {
        const docRef = window.firebaseDoc(window.firebaseDB, 'config', 'leaderboard');
        
        if (resultsUnsubscribe) {
            resultsUnsubscribe();
        }

        resultsUnsubscribe = window.firebaseOnSnapshot(docRef, 
            () => {
                console.log('Leaderboard status changed, updating results tab...');
                const resultsTab = document.getElementById('tab-results');
                if (resultsTab && resultsTab.classList.contains('active')) {
                    updateResultsTabState();
                }
            },
            (error) => {
                console.error('Error listening to leaderboard status:', error);
            }
        );

        console.log('✅ Results tab real-time listener active');
    } catch (error) {
        console.error('Error setting up results listener:', error);
    }
}

function setupAlertListener() {
    if (!window.firebaseDB || !window.firebaseOnSnapshot) {
        console.warn('Firebase not ready for alerts');
        setTimeout(setupAlertListener, 1000);
        return;
    }
    
    try {
        const alertsRef = window.firebaseCollection(window.firebaseDB, 'alerts');
        
        if (alertsUnsubscribe) {
            alertsUnsubscribe();
        }
        
        alertsUnsubscribe = window.firebaseOnSnapshot(alertsRef,
            (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const alert = change.doc.data();
                        
                        if (alert.targetTeam === 'all' || alert.targetTeam === teamCode) {
                            if (!alert.read) {
                                showAlert(alert.message, change.doc.id);
                            }
                        }
                    }
                });
            },
            (error) => {
                console.error('Error listening to alerts:', error);
            }
        );
        
        console.log('✅ Alert listener active for team:', teamCode);
    } catch (error) {
        console.error('Error setting up alert listener:', error);
    }
}

function showAlert(message, alertId) {
    const notification = document.getElementById('alertNotification');
    const overlay = document.getElementById('alertOverlay');
    const messageContent = document.getElementById('alertMessageContent');
    
    messageContent.textContent = message;
    
    overlay.style.display = 'block';
    notification.style.display = 'block';
    
    notification.dataset.alertId = alertId;
    
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PVajk7adaFQxKouHvumoiBTeP1PPRgzQFI3fH8NSMPwoVYbfo66tXFgxIoOLyu2sjBzKK0fPSgzUGImzA6+ScSg0OWKjl7qhbFgxKo+LvvWwjBjmO1fPQgTMFI3jH8NOOQAoVYbjp66tVFgtIpODxvGwiBlmH0PPUgjQHHm3B7+SbSg0PVqnl76hbFQxKpOPvwGwjBzmK0vPRgTMFJXfH8NSNQAoUYbjq66tYFwxIpODxvWwiBzaJ0fPThDQGHmzA6+ObSg0PV6jk7qhbFQxKpOHvwGwhBzaM0/PRgTMGI3fH8NONPwoUYbjq66tZFgtIpODxvWwiBjiK0vLSgzUGH23B6+ObTAwOWKjl76dcFQxKo+HvwGwiBzmL0fPShDUGI3fH8NOOQAoUYbfp66tZFgtIpN/xvGwiBjiJ0vLSgzUGH23A6+ObTAwOWKfk76dbFgxLpODvv2wiBzmM0/PRgzMGI3fH79ONPwoVYrjp66tZFgtFpODxvGwiBjiJ0vLSgzUGH23A6+ObTAwOWKjk76dcFQxLpODvv2wiBzmM0/PRgjMGJHbH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23A6+ObTAwOWKjk76dcFQxLpODvv2wiBzmM0vPRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGwiBjiJ0vLSgzUGH23B6+OaTAwOWKjk76dbFgxMpODvv2wiBzmM0/PRgjMGJHfH79CNQAoVYrjp66tYFgtFpODxvGw');
        audio.play().catch(e => console.log('Audio play failed:', e));
    } catch (e) {
        console.log('Could not play notification sound:', e);
    }
}

window.closeAlert = async function() {
    const notification = document.getElementById('alertNotification');
    const overlay = document.getElementById('alertOverlay');
    const alertId = notification.dataset.alertId;
    
    if (alertId && window.firebaseDB) {
        try {
            const alertRef = window.firebaseDoc(window.firebaseDB, 'alerts', alertId);
            await window.firebaseSetDoc(alertRef, { read: true }, { merge: true });
        } catch (error) {
            console.error('Error marking alert as read:', error);
        }
    }
    
    notification.style.display = 'none';
    overlay.style.display = 'none';
};

function initTabsWithResults() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');

    tabButtons.forEach(button => {
        button.addEventListener('click', async () => {
            const targetTab = button.getAttribute('data-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(`tab-${targetTab}`).classList.add('active');
            if (targetTab === 'results') {
                await updateResultsTabState();
            }
        });
    });
}

let activityTimeout;

function trackActivity() {
    clearTimeout(activityTimeout);
    activityTimeout = setTimeout(() => {
        StorageManager.syncSessionToFirebase();
    }, 30000);
}

['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, trackActivity, { passive: true });
});

document.addEventListener('visibilitychange', () => {
    if (!document.hidden && StorageManager.isSessionActive()) {
        StorageManager.syncSessionToFirebase();
    }
});

window.addEventListener('beforeunload', () => {
    StorageManager.syncSessionToFirebase();
});

window.addEventListener('DOMContentLoaded', async () => {
    console.log('🔄 Initializing tabs...');
    initTabsWithResults();
    console.log('✅ Tabs initialized');
    const urlParams = new URLSearchParams(window.location.search);
    const requestedTab = urlParams.get('tab');
    if (requestedTab) {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabPanes.forEach(pane => pane.classList.remove('active'));
        const targetButton = document.querySelector(`[data-tab="${requestedTab}"]`);
        const targetPane = document.getElementById(`tab-${requestedTab}`);
        if (targetButton && targetPane) {
            targetButton.classList.add('active');
            targetPane.classList.add('active');
        }
    }

    if (!StorageManager.isAuthenticated()) {
        console.warn('⚠️ Not authenticated, redirecting to member entry...');
		window.location.href = 'team_entry.html';
        return;
    }
    
    const { teamCode: authTeamCode, memberName } = StorageManager.getAuth();
    if (authTeamCode) {
        teamCode = authTeamCode;
    }
    
    console.log(`✅ Authenticated as ${memberName} in team ${teamCode}`);
    await StorageManager.syncSessionToFirebase();

    try {
        const teamData = await getTeamData();
        if (!teamData.unlocked) {
            console.warn(`⚠️ Team ${teamCode} has no unlock data, initializing empty array`);
            teamData.unlocked = [];
        }
        
        console.log(`✅ Team ${teamCode} loaded successfully`);
    } catch (error) {
        console.error('Error checking/creating team:', error);
    }

    try {
        if (typeof SuspectsModule !== 'undefined') {
            SuspectsModule.renderSuspects('suspectsContainer');
        } else {
            console.error('SuspectsModule not loaded! Make sure suspects.js is included before this script.');
        }
        
        renderEvidence();
        const teamData = await getTeamData();
        await updateProgress(teamData);
        await initSolutionTab(teamData);
        
    } catch (error) {
        console.error('Error during initialization:', error);
        alert('Σφάλμα φόρτωσης! Παρακαλώ ανανεώστε τη σελίδα.');
    }

    setInterval(async () => {
        const solutionTab = document.getElementById('tab-solution');
        if (solutionTab && solutionTab.classList.contains('active')) {
            const teamData = await getTeamData();
            const solutionForm = document.getElementById('solutionForm');
            if (teamData.solution && solutionForm && solutionForm.style.display !== 'none') {
                console.log('Solution detected from another source, refreshing display...');
                await initSolutionTab(teamData);
            }
        }
    }, 5000);

    let firestoreUnsubscribe = null;

    function setupRealtimeListener() {
        if (!window.firebaseDB || !window.firebaseOnSnapshot) {
            console.warn('Firebase not ready, falling back to polling');
            setInterval(checkForUpdates, 3000);
            return;
        }
        
        try {
            const docRef = window.firebaseDoc(window.firebaseDB, 'teams', teamCode);
            
            firestoreUnsubscribe = window.firebaseOnSnapshot(docRef, 
                (doc) => {
                    if (doc.exists()) {
                        const firebaseData = doc.data();
                        console.log('⚡ Real-time update received for team:', teamCode);
                        
                        localStorage.setItem(getStorageKey(), JSON.stringify(firebaseData));
                        renderEvidence();
                        updateProgress(firebaseData);
                        
                        const solutionTab = document.getElementById('tab-solution');
                        if (solutionTab && solutionTab.classList.contains('active')) {
                            initSolutionTab(firebaseData);
                        }
                    }
                }, 
                (error) => {
                    console.error('Real-time listener error:', error);
                    setInterval(checkForUpdates, 3000);
                }
            );
            
            console.log('✅ Real-time listener active for team:', teamCode);
        } catch (error) {
            console.error('Error setting up real-time listener:', error);
            setInterval(checkForUpdates, 3000);
        }
    }

    async function checkForUpdates() {
        if (!window.firebaseDB) return;
        
        try {
            const docRef = window.firebaseDoc(window.firebaseDB, 'teams', teamCode);
            const docSnap = await window.firebaseGetDoc(docRef);
            
            if (docSnap.exists()) {
                const firebaseData = docSnap.data();
                const localData = await getTeamData();
                
                if (firebaseData.lastUpdate && 
                    (!localData.lastUpdate || firebaseData.lastUpdate > localData.lastUpdate)) {
                    
                    localStorage.setItem(getStorageKey(), JSON.stringify(firebaseData));
                    renderEvidence();
                    await updateProgress(firebaseData);
                }
            }
        } catch (error) {
            console.error('Error checking for updates:', error);
        }
    }

    setTimeout(() => {
        setupRealtimeListener();
    }, 500);
    
    setTimeout(() => {
        setupResultsListener();
    }, 1000);
    
    setTimeout(() => {
        setupAlertListener();
    }, 1000);
});

window.addEventListener('resize', () => {
    const table = document.getElementById('resultsTable');
    const cards = document.getElementById('resultsCards');
    
    if (table && cards) {
        if (window.innerWidth > 768) {
            table.style.display = 'table';
            cards.style.display = 'none';
        } else {
            table.style.display = 'none';
            cards.style.display = 'block';
        }
    }
});

window.addEventListener('beforeunload', () => {
    stopTimer();
    if (typeof firestoreUnsubscribe === 'function') {
        firestoreUnsubscribe();
    }
    if (resultsUnsubscribe) {
        resultsUnsubscribe();
    }
    if (alertsUnsubscribe) {
        alertsUnsubscribe();
    }
});
</script>

</body>
</html>