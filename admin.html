<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - TEK Management</title>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const firebaseConfig = {
          apiKey: "AIzaSyA_9_40aa_wO_19g-1bIrSB6742aMOPwjo",
          authDomain: "crime-festival-2025.firebaseapp.com",
          projectId: "crime-festival-2025",
          storageBucket: "crime-festival-2025.firebasestorage.app",
          messagingSenderId: "663770004335",
          appId: "1:663770004335:web:e42dbd983ab9b5277bc69a"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
		window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseCollection = collection;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseOnSnapshot = onSnapshot;
        
        console.log("âœ… Firebase connected!");
    </script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    min-height: 100vh;
    padding: 20px;
    overflow-x: hidden;
    max-width: 100vw;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    overflow-x: hidden;
}

.header {
    background: linear-gradient(135deg, #ff6b00 0%, #ff8800 100%);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.header h1 {
    color: white;
    font-size: clamp(20px, 5vw, 32px);
    margin-bottom: 8px;
}

.header p {
    color: rgba(255,255,255,0.9);
    font-size: clamp(12px, 3vw, 16px);
}

.section {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.section h2 {
    color: #1a1a2e;
    font-size: clamp(18px, 4vw, 24px);
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 3px solid #ff6b00;
}

.team-input {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
    flex-direction: column;
}

.team-input input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.2s ease;
}

.team-input input:focus {
    outline: none;
    border-color: #ff6b00;
}

.btn {
    padding: 14px 20px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    width: 100%;
    min-height: 44px;
}

.btn:hover {
    transform: translateY(-2px);
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: linear-gradient(135deg, #ff6b00 0%, #ff8800 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(255,107,0,0.3);
}

.btn-primary:hover {
    box-shadow: 0 6px 20px rgba(255,107,0,0.5);
}

.btn-danger {
    background: #dc3545;
    color: white;
    box-shadow: 0 4px 15px rgba(220,53,69,0.3);
}

.btn-success {
    background: #28a745;
    color: white;
    box-shadow: 0 4px 15px rgba(40,167,69,0.3);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.team-list {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-top: 15px;
}

.team-card {
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 15px;
    transition: transform 0.2s ease;
    overflow: hidden;
    max-width: 100%;
}

.team-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.team-card.completed {
    border: 3px solid #28a745;
    background: linear-gradient(135deg, #f0fff4 0%, #d4edda 100%);
}

.team-card h3 {
    color: #0f3460;
    font-size: clamp(16px, 4vw, 20px);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.tek-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
    gap: 6px;
    margin: 12px 0;
    max-width: 100%;
    overflow: hidden;
    width: 100%;
}

.tek-box {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 5px;
    font-size: clamp(10px, 2vw, 12px);
    font-weight: bold;
    border: 2px solid #ddd;
    background: white;
    min-height: 44px;
    min-width: 44px;
    padding: 4px;
    transition: all 0.2s ease;
}

.tek-box.unlocked {
    background: #d4edda;
    border-color: #28a745;
    color: #155724;
}

.tek-box.clickable {
    cursor: pointer;
}

.tek-box.clickable:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.tek-box.clickable:active {
    transform: scale(0.95);
}

.tek-box.disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.tek-box.unlocked.clickable:hover {
    background: #b8dacc;
    border-color: #1e7e34;
}

.tek-box:not(.unlocked).clickable:hover {
    background: #fff3cd;
    border-color: #ffc107;
}

.team-actions {
    display: flex;
    gap: 8px;
    flex-direction: column;
}

.team-actions .btn {
    font-size: 14px;
    padding: 12px 16px;
}

.quick-actions {
    display: flex;
    gap: 10px;
    flex-direction: column;
    margin-bottom: 15px;
}

.sort-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
    align-items: stretch;
    flex-direction: column;
}

.sort-controls label {
    font-weight: bold;
    color: #333;
    font-size: 14px;
}

.sort-controls select {
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    width: 100%;
    transition: border-color 0.2s ease;
}

.sort-controls select:focus {
    outline: none;
    border-color: #ff6b00;
}

.progress-bar {
    background: #e0e0e0;
    height: 30px;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    background: linear-gradient(135deg, #ff6b00 0%, #ff8800 100%);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 13px;
    transition: width 0.3s ease;
}

.team-stats {
    font-size: clamp(12px, 2.5vw, 14px);
    color: #666;
    margin-bottom: 8px;
    line-height: 1.5;
}

.timing-info strong {
    display: block;
    margin-bottom: 3px;
    color: #333;
}

.completion-badge {
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: bold;
    display: inline-block;
    margin-left: 5px;
}

.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
}

.alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-danger {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.url-generator {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
}

.url-generator h3 {
    color: #0f3460;
    margin-bottom: 15px;
}

.url-list {
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 12px;
    font-family: monospace;
    font-size: 11px;
    max-height: 200px;
    overflow-y: auto;
    word-break: break-all;
}

.url-list div {
    padding: 5px;
    border-bottom: 1px solid #eee;
}

.url-list div:last-child {
    border-bottom: none;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    overflow: auto;
    padding: 10px;
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 12px;
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 2px solid #ff6b00;
}

.modal-header h2 {
    color: #1a1a2e;
    font-size: clamp(18px, 4vw, 24px);
}

.close-modal {
    font-size: 28px;
    cursor: pointer;
    color: #999;
    line-height: 1;
    padding: 5px 10px;
    transition: color 0.2s ease;
}

.close-modal:hover {
    color: #333;
}

.info-box {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: clamp(12px, 2.5vw, 14px);
}

.info-box-start {
    background: #e3f2fd;
    border-left: 3px solid #2196f3;
}

.info-box-complete {
    background: #d4edda;
    border-left: 3px solid #28a745;
}

.info-box strong {
    display: block;
    margin-bottom: 5px;
}

.timestamp-list {
    list-style: none;
    padding: 0;
}

.timestamp-item {
    padding: 12px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border-left: 3px solid #ff6b00;
    border-radius: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
}

.timestamp-item .tek-label {
    font-weight: bold;
    color: #0f3460;
}

.timestamp-item .time {
    color: #666;
    font-size: 13px;
}

#firebaseStatus {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 11px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: none;
    max-width: 250px;
    line-height: 1.4;
    z-index: 9999;
}

@media (min-width: 576px) {
    body {
        padding: 20px;
    }

    .section {
        padding: 20px;
    }

    .header {
        padding: 25px;
    }

    .team-input {
        flex-direction: row;
    }

    .team-input input {
        min-width: 200px;
    }

    .quick-actions {
        flex-direction: row;
        flex-wrap: wrap;
    }

    .btn {
        width: auto;
    }

    .team-actions {
        flex-direction: row;
        flex-wrap: wrap;
    }

    .sort-controls {
        flex-direction: row;
        align-items: center;
    }

    .sort-controls select {
        width: auto;
        min-width: 200px;
    }
}

@media (min-width: 768px) {
    .section {
        padding: 25px;
    }

    .header {
        padding: 30px;
    }

    .team-card {
        padding: 15px 10px;
    }

    .tek-grid {
        grid-template-columns: repeat(11, minmax(0, 1fr));
        gap: 5px;
        width: 100%;
        max-width: 100%;
    }

    .tek-box {
        font-size: clamp(9px, 1vw, 11px);
        min-width: 38px;
        min-height: 38px;
        border-width: 1px;
        padding: 3px;
    }

    .team-list {
        grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
    }

    .modal-content {
        padding: 30px;
    }
}

@media (min-width: 1024px) {
    .section {
        padding: 30px;
    }

    .team-list {
        grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
        gap: 20px;
    }

    .team-card {
        padding: 20px 15px;
    }

    .tek-grid {
        gap: 6px;
    }
}

@media (max-height: 600px) and (orientation: landscape) {
    .header {
        padding: 15px;
        margin-bottom: 15px;
    }

    .section {
        padding: 15px;
        margin-bottom: 15px;
    }

    .modal-content {
        max-height: 85vh;
    }
}
</style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” CRIME MANAGEMENT - ADMIN PANEL</h1>
            <p>Î”Î™Î‘Î§Î•Î™Î¡Î™Î£Î— ÎŸÎœÎ‘Î”Î©Î & Î Î‘Î¡Î‘ÎšÎŸÎ›ÎŸÎ¥Î˜Î—Î£Î— Î Î¡ÎŸÎŸÎ”ÎŸÎ¥</p>
        </div>
	
        <div class="section">
            <h2>â• Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— ÎŸÎœÎ‘Î”Î‘Î£</h2>
<div class="team-input">
    <input type="text" id="newTeamName" placeholder="ÎŸÎÎŸÎœÎ‘" />
    <input type="text" id="newTeamPassword" placeholder="ÎšÎ©Î”Î™ÎšÎŸÎ£" />
    <input type="number" id="newTeamSize" placeholder="ÎœÎ•Î›Î— (1-10)" min="1" max="10" />
    <button class="btn btn-primary" onclick="addTeam()">Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— ÎŸÎœÎ‘Î”Î‘Î£</button>
</div>
            <div id="addTeamAlert"></div>
        </div>

        <div class="section">
            <h2>ğŸ‘¥ Î•ÎÎ•Î¡Î“Î•Î£ ÎŸÎœÎ‘Î”Î•Î£</h2>
            <div class="quick-actions">
                <button class="btn" style="background: #17a2b8; color: white;" onclick="exportAllData()">ğŸ’¾ EXPORT DATA (GAME)</button>
                <button class="btn" style="background: #6c757d; color: white;" onclick="importData()">ğŸ“¥ IMPORT DATA (GAME)</button>
				<button class="btn" style="background: #ffc107; color: #000;" onclick="window.location.href='leaderboard.html'">ğŸ† LEADERBOARD (ADMIN)</button>
				<button class="btn" id="leaderboardToggleBtn" style="background: #dc3545; color: white;" onclick="toggleLeaderboard()">
					ğŸ”’ LOADING...
				</button>
                <button class="btn btn-secondary" onclick="unlockAllForAll()">ğŸ”“ ÎÎ•ÎšÎ›Î•Î™Î”Î©ÎœÎ‘ Î¤Î•ÎšÎœÎ—Î¡Î™Î©Î</button>
                <button class="btn btn-danger" onclick="resetAll()">ğŸ—‘ï¸ Î”Î™Î‘Î“Î¡Î‘Î¦Î— ÎŸÎ›Î©Î (ÎŸÎœÎ‘Î”Î•Î£)</button>
            </div>
            
            <div class="sort-controls">
                <label>Î¤Î‘ÎÎ™ÎÎŸÎœÎ—Î£Î—:</label>
                <select id="sortOrder" onchange="refreshTeams()">
                    <option value="name">ÎŸÎÎŸÎœÎ‘</option>
                    <option value="progress">Î Î¡ÎŸÎŸÎ”ÎŸÎ£</option>
                    <option value="completion">Î§Î¡ÎŸÎÎŸÎ£ ÎŸÎ›ÎŸÎšÎ›Î—Î¡Î©Î£Î—Î£ (Î¤Î‘Î§Î¥Î¤Î•Î¡ÎŸ)</option>
                    <option value="recent">Î Î™ÎŸ Î Î¡ÎŸÎ£Î¦Î‘Î¤ÎŸ</option>
                </select>
            </div>
            
            <div id="teamsContainer" class="team-list"></div>
            <div id="noTeams" style="display: none; text-align: center; padding: 40px; color: #999;">
                <p style="font-size: 18px;">Î”Î•Î Î¥Î Î‘Î¡Î§ÎŸÎ¥Î ÎŸÎœÎ‘Î”Î•Î£ Î‘ÎšÎŸÎœÎ‘</p>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”— URL GENERATOR (QR CODES)</h2>
            <div class="team-input">
                <input type="text" id="urlTeamName" placeholder="ÎŒÎ½Î¿Î¼Î± Î¿Î¼Î¬Î´Î±Ï‚" />
                <button class="btn btn-primary" onclick="generateUrls()">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± URLs</button>
            </div>
            <div class="url-generator" id="urlOutput" style="display: none;">
                <h3>URLs Î³Î¹Î± QR Codes:</h3>
                <div class="url-list" id="urlList"></div>
                <button class="btn btn-secondary" style="margin-top: 15px;" onclick="copyAllUrls()">ğŸ“‹ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® ÎŒÎ»Ï‰Î½</button>
            </div>
        </div>
    </div>

    <div id="timestampModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTeamName">Î§Î¡ÎŸÎÎ™ÎšÎ‘ Î£Î—ÎœÎ•Î™Î‘</h2>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="firebaseStatus">
        âœ… Firebase Connected - Data Synced to Cloud
    </div>

<script>
let teamsData = {};
    const BASE_URL = window.location.origin + window.location.pathname.replace('admin.html', '');
    const TOTAL_TEKS = 11;
    
    function isFirebaseReady() {
        return typeof window.firebaseDB !== 'undefined';
    }

    function formatTime(ms) {
        if (!ms) return 'N/A';
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        const h = hours;
        const m = minutes % 60;
        const s = seconds % 60;
        
        if (h > 0) {
            return `${h}Ï‰ ${m}Î» ${s}Î´`;
        } else if (m > 0) {
            return `${m}Î» ${s}Î´`;
        } else {
            return `${s}Î´`;
        }
    }

    function formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        return new Date(isoString).toLocaleString('el-GR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    async function saveTeamToFirebase(teamName, data) {
        if (!isFirebaseReady()) return false;
        try {
            await window.firebaseSetDoc(
                window.firebaseDoc(window.firebaseDB, 'teams', teamName),
                { ...data, lastUpdate: new Date().toISOString() }
            );
            console.log('âœ… Firebase save successful');
            return true;
        } catch (error) {
            console.error('âŒ Firebase save error:', error);

            const status = document.getElementById('firebaseStatus');
            if (status) {
                status.style.background = '#dc3545';
                status.innerHTML = 'âš ï¸ Firebase Sync Failed - Using Local Storage';
                status.style.display = 'block';
            }
            
            return false;
        }
    }

    async function loadTeamFromFirebase(teamName) {
        if (!isFirebaseReady()) return null;
        try {
            const docRef = window.firebaseDoc(window.firebaseDB, 'teams', teamName);
            const docSnap = await window.firebaseGetDoc(docRef);
            return docSnap.exists() ? docSnap.data() : null;
        } catch (error) {
            console.error('Firebase load error:', error);
            return null;
        }
    }

    async function getAllTeamsFromFirebase() {
        if (!isFirebaseReady()) return [];
        try {
            const querySnapshot = await window.firebaseGetDocs(
                window.firebaseCollection(window.firebaseDB, 'teams')
            );
            const teams = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                
                if (!data.deleted) {
                    teams.push({ name: doc.id, ...data });
                }
            });
            
            console.log(`ğŸ”¥ Firebase returned ${teams.length} teams`);
            return teams;
        } catch (error) {
            console.error('Firebase load all error:', error);
            return [];
        }
    }

    async function getAllTeams() {
        const allTeams = new Map();
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('unlocked_teks_')) {
                const teamName = key.replace('unlocked_teks_', '');
                const storedData = JSON.parse(localStorage.getItem(key));

                if (Array.isArray(storedData)) {
                    allTeams.set(teamName, { 
                        name: teamName, 
                        unlocked: storedData,
                        timestamps: {},
                        startTime: null,
                        completedAt: null,
                        totalTimeMs: null,
                        solution: null,
                        lastUpdate: null,
                        source: 'localStorage-legacy'
                    });
                } else {
                    allTeams.set(teamName, {
                        name: teamName,
                        ...storedData,
                        source: 'localStorage'
                    });
                }
            }
        }

        if (isFirebaseReady()) {
            try {
                const firebaseTeams = await getAllTeamsFromFirebase();
                firebaseTeams.forEach(team => {
                    console.log(`ğŸ“¦ Loading team ${team.name} from Firebase:`, team);
                    
                    const localTeam = allTeams.get(team.name);
                    if (!localTeam) {
                        allTeams.set(team.name, {
                            name: team.name,
                            password: team.password || null,
                            unlocked: team.unlocked || [],
                            timestamps: team.timestamps || {},
                            startTime: team.startTime || null,
                            completedAt: team.completedAt || null,
                            totalTimeMs: team.totalTimeMs || null,
                            lastUpdate: team.lastUpdate || null,
                            solution: team.solution || null, 
                            evidenceTimestamps: team.evidenceTimestamps || {},
                            source: 'firebase'
                        });
                    } else if (team.lastUpdate && localTeam.lastUpdate && team.lastUpdate > localTeam.lastUpdate) {
                        console.log(`ğŸ”¥ Firebase data is newer for ${team.name}`);
                        allTeams.set(team.name, {
                            name: team.name,
                            password: team.password || null,
                            unlocked: team.unlocked || [],
                            timestamps: team.timestamps || {},
                            startTime: team.startTime || null,
                            completedAt: team.completedAt || null,
                            totalTimeMs: team.totalTimeMs || null,
                            lastUpdate: team.lastUpdate || null,
                            solution: team.solution || null, 
                            evidenceTimestamps: team.evidenceTimestamps || {},
                            source: 'firebase-newer'
                        });
                    } else {
                        console.log(`ğŸ’¾ localStorage data is newer for ${team.name}`);
                    }
                });
            } catch (error) {
                console.error('âš ï¸ Firebase load failed, using localStorage only:', error);
            }
        }
        
        return Array.from(allTeams.values());
    }

async function saveTeam(teamName, data) {
    if (data.teamSize !== undefined && data.teamSize !== null) {
        data.teamSize = parseInt(data.teamSize);
        if (isNaN(data.teamSize) || data.teamSize < 1) {
            console.error(`Invalid teamSize for team ${teamName}:`, data.teamSize);
            alert('Error: Invalid team size!');
            return false;
        }
    }
    
    data.lastUpdate = new Date().toISOString();
    localStorage.setItem(`unlocked_teks_${teamName}`, JSON.stringify(data));
    const firebaseSuccess = await saveTeamToFirebase(teamName, data);
    
    if (!firebaseSuccess) {
        console.warn('âš ï¸ Continuing with localStorage only for team:', teamName);
        alert('Warning: Team created locally but Firebase save failed. Contact admin if this persists.');
    }
    
    if (firebaseSuccess && window.firebaseDB) {
        const docRef = window.firebaseDoc(window.firebaseDB, 'teams', teamName);
        const verify = await window.firebaseGetDoc(docRef);
        if (verify.exists()) {
            const saved = verify.data();
            console.log('âœ… Verified team saved with teamSize:', saved.teamSize);
            if (!saved.teamSize || saved.teamSize < 1) {
                console.error('âŒ teamSize not saved correctly!', saved);
                alert(`ERROR: Team created but teamSize is ${saved.teamSize}. Please check Firebase manually.`);
            }
        }
    }
    
    return true;
}
    async function exportAllData() {
        const teams = await getAllTeams();
        
        const dataStr = JSON.stringify({ 
            exportDate: new Date().toISOString(),
            teams: teams 
        }, null, 2);
        
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `crime-festival-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert(`âœ… Exported ${teams.length} teams to JSON file!`);
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            const text = await file.text();
            const data = JSON.parse(text);
            
            let imported = 0;
            for (const team of data.teams) {
                await saveTeam(team.name, team);
                imported++;
            }
            
            alert(`âœ… Imported ${imported} teams!`);
            refreshTeams();
        };
        
        input.click();
    }

async function addTeam() {
    const alertDiv = document.getElementById('addTeamAlert');
    const teamName = document.getElementById('newTeamName').value.trim().toLowerCase();
    const password = document.getElementById('newTeamPassword').value.trim();
    const teamSize = parseInt(document.getElementById('newTeamSize').value);

    if (!teamName) {
        alertDiv.innerHTML = '<div class="alert alert-danger">âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ ÏŒÎ½Î¿Î¼Î± Î¿Î¼Î¬Î´Î±Ï‚</div>';
        return;
    }

    if (!password) {
        alertDiv.innerHTML = '<div class="alert alert-danger">âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ ÎºÏ‰Î´Î¹ÎºÏŒ Î¿Î¼Î¬Î´Î±Ï‚</div>';
        return;
    }

    if (!teamSize || teamSize < 1 || teamSize > 10) {
        alertDiv.innerHTML = '<div class="alert alert-danger">âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î±ÏÎ¹Î¸Î¼ÏŒ Î¼ÎµÎ»ÏÎ½ (1-10)</div>';
        return;
    }

    if (isFirebaseReady()) {
        const docRef = window.firebaseDoc(window.firebaseDB, 'teams', teamName);
        const docSnap = await window.firebaseGetDoc(docRef);
        if (docSnap.exists()) {
            alertDiv.innerHTML = '<div class="alert alert-warning">âš ï¸ Î— Î¿Î¼Î¬Î´Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î·</div>';
            return;
        }
    }
    const teamData = {
        password: password,
        teamSize: teamSize,
        unlocked: [],
        timestamps: {},
        evidenceTimestamps: {},
        startTime: null,
        completedAt: null,
        totalTimeMs: null,
        solution: null,
        createdAt: new Date().toISOString()
    };
    
    console.log('Creating team with data:', teamData); 
    
    await saveTeam(teamName, teamData);
    
    alertDiv.innerHTML = `<div class="alert alert-success">âœ… Î— Î¿Î¼Î¬Î´Î± "${teamName}" Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î¼Îµ ÎºÏ‰Î´Î¹ÎºÏŒ: <strong>${password}</strong> ÎºÎ±Î¹ <strong>${teamSize} Î¼Î­Î»Î·</strong></div>`;
    document.getElementById('newTeamName').value = '';
    document.getElementById('newTeamPassword').value = '';
    document.getElementById('newTeamSize').value = '';
    
    setTimeout(() => { alertDiv.innerHTML = ''; }, 5000);
    refreshTeams();
}

async function refreshTeams() {
    console.log('ğŸ”„ === REFRESH TEAMS START ===');
    let teams = await getAllTeams();
    
    // Populate global teamsData for timer updates
    teamsData = {};
    teams.forEach(team => {
        teamsData[team.name] = team;
    });
    
    const container = document.getElementById('teamsContainer');
    const noTeams = document.getElementById('noTeams');
    const sortOrder = document.getElementById('sortOrder').value;

    console.log(`ğŸ“Š Loaded ${teams.length} teams from Firebase/localStorage`);
    teams.forEach(t => console.log(`  - ${t.name}: ${t.unlocked.length} TEKs unlocked, data:`, t.unlocked));

    if (teams.length === 0) {
        container.innerHTML = '';
        noTeams.style.display = 'block';
        
        // Clear any existing timer interval
        if (window.timerInterval) {
            clearInterval(window.timerInterval);
        }
        
        console.log('ğŸ”„ === REFRESH TEAMS END ===');
        return;
    }
    
    teams = sortTeams(teams, sortOrder);

    noTeams.style.display = 'none';
    container.innerHTML = '';
    
    // Clear any existing timer interval
    if (window.timerInterval) {
        clearInterval(window.timerInterval);
    }
    
// Update all timers every second
window.timerInterval = setInterval(() => {
    document.querySelectorAll('.team-card').forEach(teamCard => {
        const teamName = teamCard.dataset.teamId;
        const team = teamsData[teamName];
        
        // Update timer only if game is in progress (started but not completed)
        if (team && team.startTime && !team.completedAt && !team.solution) {
            const elapsed = Date.now() - new Date(team.startTime).getTime();
            
            // Find the timer element more specifically
            const timerStats = Array.from(teamCard.querySelectorAll('.team-stats')).find(
                el => el.textContent.includes('Î£Î• Î•ÎÎ•Î›Î™ÎÎ—')
            );
            
            if (timerStats) {
                timerStats.innerHTML = `â±ï¸ Î§Î¡ÎŸÎÎŸÎ£ Î£Î• Î•ÎÎ•Î›Î™ÎÎ—: <strong>${formatTime(elapsed)}</strong>`;
            }
        }
    });
}, 1000);
    
    const html = teams.map(team => {
        const progress = Math.round((team.unlocked.length / TOTAL_TEKS) * 100);
        const allEvidenceUnlocked = team.unlocked.length === TOTAL_TEKS;
        const solutionSubmitted = !!team.solution;
        
        let timingHtml = '';
        if (team.startTime) {
            const now = new Date();
            const startTime = new Date(team.startTime);
            
            if (solutionSubmitted && team.completedAt) {
                timingHtml = `
                    <div class="team-stats">â±ï¸ Î§Î¡ÎŸÎÎŸÎ£ ÎŸÎ›ÎŸÎšÎ›Î—Î¡Î©Î£Î—Î£: <strong>${formatTime(team.totalTimeMs)}</strong></div>
                `;
            } else {
                const elapsed = now - startTime;
                timingHtml = `
                    <div class="team-stats">â±ï¸ Î§Î¡ÎŸÎÎŸÎ£ Î£Î• Î•ÎÎ•Î›Î™ÎÎ—: <strong>${formatTime(elapsed)}</strong></div>
                `;
            }
        }
  
        console.log(`ğŸ¨ Rendering team ${team.name} with unlocked:`, team.unlocked);
            
        return `
            <div class="team-card ${solutionSubmitted ? 'completed' : ''}" data-team-id="${team.name}">
                <h3>
                    <span style="font-size: 24px;">ğŸ‘¥</span> 
                    ${team.name.toUpperCase()}
                    ${solutionSubmitted ? 
                        '<span class="completion-badge">âœ… ÎŸÎ›ÎŸÎšÎ›Î—Î¡Î©Î˜Î—ÎšÎ•</span>' : 
                        (allEvidenceUnlocked ? '<span class="completion-badge" style="background: #17a2b8;">ğŸ“¦ Î Î›Î—Î¡Î—Î£ Î£Î¥Î›Î›ÎŸÎ“Î—</span>' : '')
                    }
                </h3>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%;">${progress}%</div>
                </div>
                <div class="team-stats">ğŸ“Š ÎÎ•ÎšÎ›Î•Î™Î”Î©ÎœÎ•ÎÎ‘: ${team.unlocked.length} / ${TOTAL_TEKS} Î£Î¤ÎŸÎ™Î§Î•Î™Î‘</div>
                <div class="team-stats">ğŸ‘¥ ÎœÎ•Î›Î—: <strong>${team.teamSize || 'N/A'}</strong></div>
                <div class="team-stats">ğŸ”‘ ÎšÎ©Î”Î™ÎšÎŸÎ£: <strong>${team.password || 'N/A'}</strong></div>
                ${timingHtml}
                <div class="tek-grid">
                    ${Array.from({length: TOTAL_TEKS}, (_, i) => {
                        const tekNum = (i + 1).toString();
                        const isUnlocked = team.unlocked.includes(tekNum);
                        const isLocked = !!team.solution;
                        
                        console.log(`  TEK ${tekNum}: unlocked=${isUnlocked}, array contains:`, team.unlocked);
                        
                        return `<div class="tek-box ${isUnlocked ? 'unlocked' : ''} ${isLocked ? 'disabled' : 'clickable'}" 
                                     onclick="${isLocked ? '' : `toggleTek('${team.name}', ${i + 1})`}" 
                                     title="${isLocked ? 'ÎšÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿ (Î»ÏÏƒÎ· Ï…Ï€Î¿Î²Î»Î®Î¸Î·ÎºÎµ)' : (isUnlocked ? 'ÎšÎ»Î¹Îº Î³Î¹Î± ÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î±' : 'ÎšÎ»Î¹Îº Î³Î¹Î± Î¾ÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î±')}">${i + 1}</div>`;
                    }).join('')}
                </div>
                <div class="team-actions">
                    <button class="btn btn-primary" onclick="viewTeam('${team.name}')">ğŸ‘ï¸ Î Î¡ÎŸÎ’ÎŸÎ›Î—</button>
                    <button class="btn" style="background: #17a2b8; color: white;" onclick="showTimestamps('${team.name}')">ğŸ• Î§Î¡ÎŸÎÎ™ÎšÎ‘</button>
                    <button class="btn btn-success" onclick="unlockAll('${team.name}')">ğŸ”“ ÎŸÎ›Î‘</button>
                    <button class="btn btn-secondary" onclick="resetTeam('${team.name}')">ğŸ”„ RESET</button>
                    <button class="btn btn-danger" onclick="deleteTeam('${team.name}')">ğŸ—‘ï¸ Î”Î™Î‘Î¦Î¡Î‘Î¦Î—</button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;        
    console.log('ğŸ”„ === REFRESH TEAMS END ===');
}

    function sortTeams(teams, order) {
        switch(order) {
            case 'name':
                return teams.sort((a, b) => a.name.localeCompare(b.name));
            
            case 'progress':
                return teams.sort((a, b) => b.unlocked.length - a.unlocked.length);
            
            case 'completion':
                const completed = teams.filter(t => t.completedAt).sort((a, b) => a.totalTimeMs - b.totalTimeMs);
                const incomplete = teams.filter(t => !t.completedAt).sort((a, b) => b.unlocked.length - a.unlocked.length);
                return [...completed, ...incomplete];
            
            case 'recent':
                return teams.sort((a, b) => {
                    const aTime = a.lastUpdate || a.startTime || '0';
                    const bTime = b.lastUpdate || b.startTime || '0';
                    return bTime.localeCompare(aTime);
                });
            
            default:
                return teams;
        }
    }

async function showTimestamps(teamName) {
    const teams = await getAllTeams();
    const team = teams.find(t => t.name === teamName);
    
    if (!team) return;

    const modal = document.getElementById('timestampModal');
    const modalTeamName = document.getElementById('modalTeamName');
    const modalContent = document.getElementById('modalContent');

    modalTeamName.textContent = `Î§Î¡ÎŸÎÎ™ÎšÎ‘ Î£Î—ÎœÎ•Î™Î‘ - ${teamName.toUpperCase()}`;

    let html = '';
    if (team.startTime || team.completedAt) {
        html += '<div class="info-box info-box-start">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 10px;">';
        
        if (team.startTime) {
            html += `<div><strong>ğŸš€ ÎˆÎ½Î±ÏÎ¾Î·:</strong> ${formatDateTime(team.startTime)}</div>`;
        }
        
        if (team.completedAt) {
            html += `<div><strong>ğŸ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·:</strong> ${formatDateTime(team.completedAt)}</div>`;
        }
        
        html += '</div>';
		
        if (team.completedAt && team.totalTimeMs) {
            html += `<div><strong>â±ï¸ Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î§ÏÏŒÎ½Î¿Ï‚:</strong> ${formatTime(team.totalTimeMs)}</div>`;
        }
        
        html += '</div>';
    }

    if (team.timestamps && Object.keys(team.timestamps).length > 0) {
        html += '<h3 style="margin: 20px 0 10px 0;">ÎÎµÎºÎ»ÎµÎ¹Î´ÏÎ¼Î±Ï„Î± Î¤Î•Îš:</h3>';
        html += '<ul class="timestamp-list">';
        const sortedTeks = Object.entries(team.timestamps)
            .sort((a, b) => new Date(a[1]) - new Date(b[1]));
        
        sortedTeks.forEach(([tek, timestamp]) => {
            html += `
                <li class="timestamp-item">
                    <span class="tek-label">Î¤Î•Îš #${tek.padStart(2, '0')}</span>
                    <span class="time">${formatDateTime(timestamp)}</span>
                </li>
            `;
        });
        
        html += '</ul>';
    } else {
        html += '<p style="color: #999; text-align: center; padding: 20px;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï‡ÏÎ¿Î½Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î±</p>';
    }

    modalContent.innerHTML = html;
    modal.classList.add('active');
}
    function closeModal() {
        const modal = document.getElementById('timestampModal');
        modal.classList.remove('active');
    }
    
    window.onclick = function(event) {
        const modal = document.getElementById('timestampModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    function viewTeam(teamName) {
        window.open(`${BASE_URL}index.html?team=${teamName}`, '_blank');
    }

    async function toggleTek(teamName, tekNumber) {
        console.log(`ğŸ¯ Toggle TEK ${tekNumber} for team ${teamName}`);
        
        const teams = await getAllTeams();
        const team = teams.find(t => t.name === teamName);
        
        if (!team) {
            alert('ÎŸÎ¼Î¬Î´Î± Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ!');
            return;
        }
        
        if (team.solution) {
            alert('âŒ Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„ÎµÎºÎ¼Î®ÏÎ¹Î± Î¼ÎµÏ„Î¬ Ï„Î·Î½ Ï…Ï€Î¿Î²Î¿Î»Î® Î»ÏÏƒÎ·Ï‚!');
            return;
        }
        
        const tekStr = tekNumber.toString();
        const unlocked = [...(team.unlocked || [])];
        const timestamps = {...(team.timestamps || {})};
        
        if (unlocked.includes(tekStr)) {
            const index = unlocked.indexOf(tekStr);
            unlocked.splice(index, 1);
            delete timestamps[tekStr];
            console.log(`ğŸ”’ Locked TEK ${tekNumber} for team ${teamName}`);
        } else {
            unlocked.push(tekStr);
            timestamps[tekStr] = new Date().toISOString();
            console.log(`ğŸ”“ Unlocked TEK ${tekNumber} for team ${teamName}`);
        }
        
        const updatedTeam = {
            ...team,
            unlocked: unlocked,
            timestamps: timestamps,
            startTime: team.startTime || new Date().toISOString(),
            lastUpdate: new Date().toISOString()
        };
        
        console.log(`ğŸ’¾ Saving team ${teamName} with ${unlocked.length} TEKs`);
        localStorage.setItem(`unlocked_teks_${teamName}`, JSON.stringify(updatedTeam));
        await refreshTeams();
        await saveTeamToFirebase(teamName, updatedTeam);
        
        console.log('âœ… Toggle complete');
    }

    async function unlockAll(teamName) {
        if (confirm(`ÎÎ•ÎšÎ›Î•Î™Î”Î©ÎœÎ‘ ÎŸÎ›Î©Î Î¤Î©Î Î¤Î•ÎšÎœÎ—Î¡Î™Î©Î Î“Î™Î‘ Î¤Î—Î ÎŸÎœÎ‘Î”Î‘ "${teamName}";`)) {
            console.log(`ğŸ”“ Unlocking all TEKs for team ${teamName}`);
            const teams = await getAllTeams();
            const team = teams.find(t => t.name === teamName);
            
            const allTeks = Array.from({length: TOTAL_TEKS}, (_, i) => (i + 1).toString());
            const now = new Date().toISOString();
            const timestamps = {...(team?.timestamps || {})};
            let earliestTime = team?.startTime || now;
            allTeks.forEach((tek, i) => {
                if (!timestamps[tek]) {
                    timestamps[tek] = new Date(Date.now() + i * 100).toISOString();
                } else {
                    const existingTime = new Date(timestamps[tek]);
                    if (existingTime < new Date(earliestTime)) {
                        earliestTime = timestamps[tek];
                    }
                }
            });
        
            const updatedTeam = {
                ...team,
                password: team?.password || null,
                unlocked: allTeks,
                timestamps: timestamps,
                startTime: earliestTime,
                lastUpdate: new Date().toISOString()
            };
        
            console.log(`ğŸ’¾ Saving unlock all for team ${teamName}`);
            localStorage.setItem(`unlocked_teks_${teamName}`, JSON.stringify(updatedTeam));
            await refreshTeams();
            await saveTeamToFirebase(teamName, updatedTeam);
            
            console.log('âœ… Unlock all complete');
        }
    }

async function resetTeam(teamName) {
    if (confirm(`Reset Ï€ÏÏŒÎ¿Î´Î¿ Î³Î¹Î± Ï„Î·Î½ Î¿Î¼Î¬Î´Î± "${teamName}";`)) {
        const teams = await getAllTeams();
        const team = teams.find(t => t.name === teamName);
        
        await saveTeam(teamName, {
            password: team?.password || null,
            teamSize: team?.teamSize || null,
            unlocked: [],
            timestamps: {},
            startTime: null,
            completedAt: null,
            totalTimeMs: null
        });
            refreshTeams();
        }
    }

async function deleteTeam(teamName) {
    if (confirm(`Î”Î™Î‘Î“Î¡Î‘Î¦Î— ÎŸÎœÎ‘Î”Î‘Î£ "${teamName}" ÎšÎ‘Î™ ÎŸÎ›Î©Î Î¤Î©Î Î£Î¥ÎÎ”Î•Î”Î•ÎœÎ•ÎÎ©Î Î•Î¡Î•Î¥ÎÎ©Î;`)) {
        console.log(`ğŸ—‘ï¸ Starting deletion for team: ${teamName}`);
        localStorage.removeItem(`unlocked_teks_${teamName}`);
        console.log(`âœ… Deleted from localStorage`);
        
        if (isFirebaseReady()) {
            try {
                const surveysRef = window.firebaseCollection(window.firebaseDB, 'surveys');
                const querySnapshot = await window.firebaseGetDocs(surveysRef);
                
                const deletePromises = [];
                let surveyCount = 0;
                
                querySnapshot.forEach((doc) => {
                    const docId = doc.id;
                    if (docId.startsWith(`${teamName}_pre_`) || docId.startsWith(`${teamName}_post_`)) {
                        console.log(`ğŸ—‘ï¸ Queuing survey for deletion: ${docId}`);
                        surveyCount++;
                        deletePromises.push(
                            window.firebaseDeleteDoc(
                                window.firebaseDoc(window.firebaseDB, 'surveys', docId)
                            ).then(() => {
                                console.log(`âœ… Deleted survey: ${docId}`);
                            }).catch(err => {
                                console.error(`âŒ Failed to delete survey ${docId}:`, err);
                            })
                        );
                    }
                });
                
                console.log(`ğŸ“Š Found ${surveyCount} surveys to delete`);
                if (deletePromises.length > 0) {
                    await Promise.all(deletePromises);
                    console.log(`âœ… All surveys deleted successfully`);
                }
				
                await window.firebaseDeleteDoc(
                    window.firebaseDoc(window.firebaseDB, 'teams', teamName)
                );
                console.log(`âœ… Deleted team document: ${teamName}`);
                
                alert(`âœ… Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ Î· Î¿Î¼Î¬Î´Î± "${teamName}" ÎºÎ±Î¹ ${surveyCount} Î­ÏÎµÏ…Î½ÎµÏ‚!`);
                
            } catch (error) {
                console.error('âŒ Firebase delete error:', error);
                alert(`âš ï¸ Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®: ${error.message}\nÎ•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿ console Î³Î¹Î± Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚.`);
            }
        } else {
            console.warn('âš ï¸ Firebase not ready, only deleted from localStorage');
            alert('âš ï¸ Firebase Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿. Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ Î¼ÏŒÎ½Î¿ Ï„Î¿Ï€Î¹ÎºÎ¬.');
        }
        
        refreshTeams();
    }
}

    async function unlockAllForAll() {
        if (confirm('ÎÎ•ÎšÎ›Î•Î™Î”Î©ÎœÎ‘ ÎŸÎ›Î©Î Î¤Î©Î Î¤Î•ÎšÎœÎ—Î¡Î™Î©Î Î“Î™Î‘ ÎŸÎ›Î•Î£ Î¤Î™Î£ ÎŸÎœÎ‘Î”Î•Î£;')) {
            const teams = await getAllTeams();
            const allTeks = Array.from({length: TOTAL_TEKS}, (_, i) => (i + 1).toString());
            
            for (const team of teams) {
                const now = new Date().toISOString();
                const timestamps = {...(team.timestamps || {})};
                let earliestTime = team.startTime || now;
                allTeks.forEach((tek, i) => {
                    if (!timestamps[tek]) {
                        timestamps[tek] = new Date(Date.now() + i * 100).toISOString();
                    } else {
                        const existingTime = new Date(timestamps[tek]);
                        if (existingTime < new Date(earliestTime)) {
                            earliestTime = timestamps[tek];
                        }
                    }
                });
                
                const completionTime = new Date();
                const startTime = new Date(earliestTime);
                const totalTimeMs = completionTime - startTime;
                
                await saveTeam(team.name, {
                    ...team,
                    unlocked: allTeks,
                    timestamps: timestamps,
                    startTime: earliestTime,
                    completedAt: now,
                    totalTimeMs: totalTimeMs
                });
            }
            refreshTeams();
        }
    }

async function resetAll() {
    if (confirm('Î”Î™Î‘Î“Î¡Î‘Î¦Î— ÎŸÎ›Î©Î Î¤Î©Î ÎŸÎœÎ‘Î”Î©Î ÎšÎ‘Î™ Î•Î¡Î•Î¥ÎÎ©Î;')) {
        const teams = await getAllTeams();
        console.log(`ğŸ—‘ï¸ Resetting ${teams.length} teams...`);
        for (const team of teams) {
            localStorage.removeItem(`unlocked_teks_${team.name}`);
        }
        console.log(`âœ… Deleted all from localStorage`);
        
        if (isFirebaseReady()) {
            try {
                for (const team of teams) {
                    await window.firebaseDeleteDoc(
                        window.firebaseDoc(window.firebaseDB, 'teams', team.name)
                    );
                    console.log(`âœ… Deleted team: ${team.name}`);
                }
				
                const surveysRef = window.firebaseCollection(window.firebaseDB, 'surveys');
                const querySnapshot = await window.firebaseGetDocs(surveysRef);
                
                const deletePromises = [];
                let surveyCount = 0;
                
                querySnapshot.forEach((doc) => {
                    console.log(`ğŸ—‘ï¸ Deleting survey: ${doc.id}`);
                    surveyCount++;
                    deletePromises.push(
                        window.firebaseDeleteDoc(
                            window.firebaseDoc(window.firebaseDB, 'surveys', doc.id)
                        )
                    );
                });
                
                await Promise.all(deletePromises);
                
                console.log(`âœ… Deleted ${teams.length} teams and ${surveyCount} surveys`);
                alert(`âœ… Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½ ${teams.length} Î¿Î¼Î¬Î´ÎµÏ‚ ÎºÎ±Î¹ ${surveyCount} Î­ÏÎµÏ…Î½ÎµÏ‚!`);
            } catch (error) {
                console.error('âŒ Firebase delete error:', error);
                alert(`âš ï¸ Î£Ï†Î¬Î»Î¼Î±: ${error.message}`);
            }
        }
        
        refreshTeams();
    }
}

    function generateUrls() {
        const teamName = document.getElementById('urlTeamName').value.trim().toLowerCase();
        const output = document.getElementById('urlOutput');
        const urlList = document.getElementById('urlList');

        if (!teamName) {
            alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ ÏŒÎ½Î¿Î¼Î± Î¿Î¼Î¬Î´Î±Ï‚');
            return;
        }

        const urls = [];
        urls.push(`<strong>Entry URL:</strong><br>${BASE_URL}index.html?team=${teamName}<br><br>`);
        urls.push(`<strong>Unlock URLs:</strong><br>`);
        
        for (let i = 1; i <= TOTAL_TEKS; i++) {
            urls.push(`TEK ${i.toString().padStart(2, '0')}: ${BASE_URL}unlock_system.html?tek=${i}&team=${teamName}`);
        }

        urlList.innerHTML = urls.join('<br>');
        output.style.display = 'block';
    }

    function copyAllUrls() {
        const urlList = document.getElementById('urlList');
        const text = urlList.innerText;
        
        navigator.clipboard.writeText(text).then(() => {
            alert('âœ… URLs Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎ±Î½ ÏƒÏ„Î¿ clipboard!');
        });
    }

    let firestoreUnsubscribe = null;
    function setupRealtimeListener() {
        if (!isFirebaseReady()) {
            console.warn('âš ï¸ Firebase not ready - using periodic refresh');
            setInterval(refreshTeams, 5000);
            return;
        }

        try {
            const teamsCollection = window.firebaseCollection(window.firebaseDB, 'teams');
            firestoreUnsubscribe = window.firebaseOnSnapshot(teamsCollection, 
                (snapshot) => {
                    console.log('ğŸ”¥ Firebase real-time update received');
                    refreshTeams();
                },
                (error) => {
                    console.error('âŒ Firebase listener error:', error);
                    if (!firestoreUnsubscribe) {
                        setInterval(refreshTeams, 5000);
                    }
                }
            );
            console.log('âœ… Real-time Firebase listener active');
        } catch (error) {
            console.error('âŒ Failed to setup Firebase listener:', error);
            setInterval(refreshTeams, 5000);
        }
    }

window.addEventListener('DOMContentLoaded', async () => {
        setTimeout(async () => {
            const status = document.getElementById('firebaseStatus');
            if (isFirebaseReady()) {
                status.style.display = 'block';
                status.innerHTML = 'Connected to Firebase - Real-time sync active';
            } else {
                console.warn('Ã¢Å¡ Ã¯Â¸ Firebase not loaded - using localStorage only');
            }
            
            refreshTeams();
            setupRealtimeListener();
            await updateLeaderboardButton();
            setInterval(updateLeaderboardButton, 5000);            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }, 300);
    });

    window.addEventListener('beforeunload', () => {
        if (firestoreUnsubscribe) {
            firestoreUnsubscribe();
        }
    });

async function checkLeaderboardStatus() {
    if (!window.firebaseDB) {
        console.warn('Firebase not ready');
        return false;
    }
    
    try {
        const docRef = window.firebaseDoc(window.firebaseDB, 'config', 'leaderboard');
        const docSnap = await window.firebaseGetDoc(docRef);
        
        if (docSnap.exists()) {
            return docSnap.data().unlocked || false;
        }
        return false;
    } catch (error) {
        console.error('Error checking leaderboard status:', error);
        return false;
    }
}

async function updateLeaderboardButton() {
    const isUnlocked = await checkLeaderboardStatus();
    const btn = document.getElementById('leaderboardToggleBtn');
    
    if (btn) {
        if (isUnlocked) {
            btn.innerHTML = 'ğŸ”“ ÎšÎ›Î•Î™Î”Î©ÎœÎ‘ LEADERBOARD (ÎŸÎœÎ‘Î”Î•Î£)';
            btn.style.background = '#28a745';
        } else {
            btn.innerHTML = 'ğŸ”’ ÎÎ•ÎšÎ›Î•Î™Î”Î©ÎœÎ‘ LEADERBOARD (ÎŸÎœÎ‘Î”Î•Î£)';
            btn.style.background = '#dc3545';
        }
    }
}

async function toggleLeaderboard() {
    if (!window.firebaseDB) {
        alert('âŒ Firebase Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿!');
        return;
    }
    
    const currentStatus = await checkLeaderboardStatus();
    const newStatus = !currentStatus;
    
    try {
        const docRef = window.firebaseDoc(window.firebaseDB, 'config', 'leaderboard');
        await window.firebaseSetDoc(docRef, {
            unlocked: newStatus,
            lastModified: new Date().toISOString(),
            modifiedBy: 'admin'
        });
        
await updateLeaderboardButton();
        
    } catch (error) {
	
        console.error('Error toggling leaderboard:', error);
        alert('âŒ Î£Ï†Î¬Î»Î¼Î±! Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.');
    }
}

</script>
</body>
</html>