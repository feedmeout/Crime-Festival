<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - TEK Management</title>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const firebaseConfig = {
          apiKey: "AIzaSyA_9_40aa_wO_19g-1bIrSB6742aMOPwjo",
          authDomain: "crime-festival-2025.firebaseapp.com",
          projectId: "crime-festival-2025",
          storageBucket: "crime-festival-2025.firebasestorage.app",
          messagingSenderId: "663770004335",
          appId: "1:663770004335:web:e42dbd983ab9b5277bc69a"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseCollection = collection;
        window.firebaseDeleteDoc = deleteDoc;
        
        console.log("✅ Firebase connected!");
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #ff6b00 0%, #ff8800 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .header h1 {
            color: white;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .section h2 {
            color: #1a1a2e;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #ff6b00;
        }

        .team-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .team-input input {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .team-input input:focus {
            outline: none;
            border-color: #ff6b00;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b00 0%, #ff8800 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255,107,0,0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(255,107,0,0.5);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .team-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .team-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.2s ease;
        }

        .team-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .team-card.completed {
            border: 3px solid #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #d4edda 100%);
        }

        .team-card h3 {
            color: #0f3460;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(135deg, #ff6b00 0%, #ff8800 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            transition: width 0.3s ease;
        }

        .team-stats {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .timing-info {
            background: rgba(255, 107, 0, 0.1);
            border-left: 3px solid #ff6b00;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
        }

        .timing-info.completed {
            background: rgba(40, 167, 69, 0.1);
            border-left: 3px solid #28a745;
        }

        .timing-info strong {
            display: block;
            margin-bottom: 3px;
            color: #333;
        }

        .completion-badge {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }

        .team-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .team-actions .btn {
            font-size: 13px;
            padding: 8px 16px;
        }

        .tek-grid {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            gap: 5px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .tek-box {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid #ddd;
            background: white;
        }

        .tek-box.unlocked {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .sort-controls label {
            font-weight: bold;
            color: #333;
        }

        .sort-controls select {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .last-update-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 10px 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #0d47a1;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
            margin-left: auto;
        }

        .last-update-box .icon {
            font-size: 16px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .url-generator {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .url-generator h3 {
            color: #0f3460;
            margin-bottom: 15px;
        }

        .url-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }

        .url-list div {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .url-list div:last-child {
            border-bottom: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            overflow: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ff6b00;
        }

        .modal-header h2 {
            color: #1a1a2e;
            font-size: 24px;
        }

        .close-modal {
            font-size: 32px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-modal:hover {
            color: #333;
        }

        .timestamp-list {
            list-style: none;
            padding: 0;
        }

        .timestamp-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-left: 3px solid #ff6b00;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timestamp-item .tek-label {
            font-weight: bold;
            color: #0f3460;
        }

        .timestamp-item .time {
            color: #666;
            font-size: 13px;
        }

        #firebaseStatus {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 11px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            max-width: 250px;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .team-list {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }

            .sort-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .last-update-box {
                margin-left: 0;
                margin-top: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔐 CRIME MANAGEMENT - ADMIN PANEL</h1>
            <p>ΔΙΑΧΕΙΡΙΣΗ ΟΜΑΔΩΝ & ΠΑΡΑΚΟΛΟΥΘΗΣΗ ΠΡΟΟΔΟΥ</p>
        </div>
	
        <div class="section">
            <h2>➕ ΠΡΟΣΘΗΚΗ ΟΜΑΔΑΣ</h2>
            <div class="team-input">
                <input type="text" id="newTeamName" placeholder="Όνομα ομάδας (π.χ. alpha, beta, ...)" />
                <button class="btn btn-primary" onclick="addTeam()">ΠΡΟΣΘΗΚΗ ΟΜΑΔΑΣ</button>
            </div>
            <div id="addTeamAlert"></div>
        </div>

        <div class="section">
            <h2>👥 ΕΝΕΡΓΕΣ ΟΜΑΔΕΣ</h2>
            <div class="quick-actions">
                <button class="btn btn-success" onclick="refreshTeams()">🔄 ΑΝΑΝΕΩΣΗ</button>
                <button class="btn" style="background: #17a2b8; color: white;" onclick="exportAllData()">💾 EXPORT</button>
                <button class="btn" style="background: #6c757d; color: white;" onclick="importData()">📥 IMPORT</button>
				<button class="btn" style="background: #ffc107; color: #000;" onclick="window.location.href='leaderboard.html'">🏆 LEADERBOARD</button>
                <button class="btn btn-secondary" onclick="unlockAllForAll()">🔓 ΞΕΚΛΕΙΔΩΜΑ ΟΛΩΝ</button>
                <button class="btn btn-danger" onclick="resetAll()">🗑️ ΔΙΑΓΡΑΦΗ ΟΛΩΝ</button>
            </div>
            
            <div class="sort-controls">
                <label>Ταξινόμηση:</label>
                <select id="sortOrder" onchange="refreshTeams()">
                    <option value="name">Όνομα</option>
                    <option value="progress">Πρόοδος</option>
                    <option value="completion">Χρόνος Ολοκλήρωσης (Ταχύτερο)</option>
                    <option value="recent">Πιο Πρόσφατο</option>
                </select>
                <div class="last-update-box" id="lastRefresh">
                    <span class="icon">🔄</span>
                    <span>Αναμονή ενημέρωσης...</span>
                </div>
            </div>
            
            <div id="teamsContainer" class="team-list"></div>
            <div id="noTeams" style="display: none; text-align: center; padding: 40px; color: #999;">
                <p style="font-size: 18px;">Δεν υπάρχουν ομάδες ακόμα</p>
            </div>
        </div>

        <div class="section">
            <h2>🔗 URL GENERATOR (QR CODES)</h2>
            <div class="team-input">
                <input type="text" id="urlTeamName" placeholder="Όνομα ομάδας" />
                <button class="btn btn-primary" onclick="generateUrls()">Δημιουργία URLs</button>
            </div>
            <div class="url-generator" id="urlOutput" style="display: none;">
                <h3>URLs για QR Codes:</h3>
                <div class="url-list" id="urlList"></div>
                <button class="btn btn-secondary" style="margin-top: 15px;" onclick="copyAllUrls()">📋 Αντιγραφή Όλων</button>
            </div>
        </div>
    </div>

    <!-- Modal for timestamp details -->
    <div id="timestampModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTeamName">Χρονικά Σημεία</h2>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="firebaseStatus">
        ✅ Firebase Connected - Data Synced to Cloud
    </div>

<script>
    const BASE_URL = window.location.origin + window.location.pathname.replace('admin.html', '');
    const TOTAL_TEKS = 11;
    
    function isFirebaseReady() {
        return typeof window.firebaseDB !== 'undefined';
    }

    function formatTime(ms) {
        if (!ms) return 'N/A';
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        const h = hours;
        const m = minutes % 60;
        const s = seconds % 60;
        
        if (h > 0) {
            return `${h}ω ${m}λ ${s}δ`;
        } else if (m > 0) {
            return `${m}λ ${s}δ`;
        } else {
            return `${s}δ`;
        }
    }

    function formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        return new Date(isoString).toLocaleString('el-GR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    // === FIREBASE FUNCTIONS ===
    async function saveTeamToFirebase(teamName, data) {
        if (!isFirebaseReady()) return;
        try {
            await window.firebaseSetDoc(
                window.firebaseDoc(window.firebaseDB, 'teams', teamName),
                { ...data, lastUpdate: new Date().toISOString() }
            );
        } catch (error) {
            console.error('Firebase save error:', error);
        }
    }

    async function loadTeamFromFirebase(teamName) {
        if (!isFirebaseReady()) return null;
        try {
            const docRef = window.firebaseDoc(window.firebaseDB, 'teams', teamName);
            const docSnap = await window.firebaseGetDoc(docRef);
            return docSnap.exists() ? docSnap.data() : null;
        } catch (error) {
            console.error('Firebase load error:', error);
            return null;
        }
    }

    async function getAllTeamsFromFirebase() {
        if (!isFirebaseReady()) return [];
        try {
            const querySnapshot = await window.firebaseGetDocs(
                window.firebaseCollection(window.firebaseDB, 'teams')
            );
            const teams = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                
                if (!data.deleted) {
                    teams.push({ name: doc.id, ...data });
                }
            });
            return teams;
        } catch (error) {
            console.error('Firebase load all error:', error);
            return [];
        }
    }

    async function getAllTeams() {
        const allTeams = new Map();
        
        // Prioritize Firebase (cloud data from all devices)
        if (isFirebaseReady()) {
            const firebaseTeams = await getAllTeamsFromFirebase();
            firebaseTeams.forEach(team => {
                // Ensure proper structure
                allTeams.set(team.name, {
                    name: team.name,
                    unlocked: team.unlocked || [],
                    timestamps: team.timestamps || {},
                    startTime: team.startTime || null,
                    completedAt: team.completedAt || null,
                    totalTimeMs: team.totalTimeMs || null,
                    lastUpdate: team.lastUpdate || null
                });
            });
        }
        
        // Then check localStorage (only for local admin changes)
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('unlocked_teks_')) {
                const teamName = key.replace('unlocked_teks_', '');
                // Only add from localStorage if not already in Firebase
                if (!allTeams.has(teamName)) {
                    const unlocked = JSON.parse(localStorage.getItem(key));
                    allTeams.set(teamName, { 
                        name: teamName, 
                        unlocked: unlocked,
                        timestamps: {},
                        startTime: null,
                        completedAt: null,
                        totalTimeMs: null
                    });
                }
            }
        }
        
        return Array.from(allTeams.values());
    }

    async function saveTeam(teamName, data) {
        // Save unlocked array to localStorage for backward compatibility
        localStorage.setItem(`unlocked_teks_${teamName}`, JSON.stringify(data.unlocked || []));
        await saveTeamToFirebase(teamName, data);
    }

    async function exportAllData() {
        const teams = await getAllTeams();
        
        const dataStr = JSON.stringify({ 
            exportDate: new Date().toISOString(),
            teams: teams 
        }, null, 2);
        
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `crime-festival-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert(`✅ Exported ${teams.length} teams to JSON file!`);
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            const text = await file.text();
            const data = JSON.parse(text);
            
            let imported = 0;
            for (const team of data.teams) {
                await saveTeam(team.name, team);
                imported++;
            }
            
            alert(`✅ Imported ${imported} teams!`);
            refreshTeams();
        };
        
        input.click();
    }

    // === UI FUNCTIONS ===
    async function addTeam() {
        const teamName = document.getElementById('newTeamName').value.trim().toLowerCase();
        const alertDiv = document.getElementById('addTeamAlert');
        
        if (!teamName) {
            alertDiv.innerHTML = '<div class="alert alert-danger">⚠️ Παρακαλώ εισάγετε όνομα ομάδας</div>';
            return;
        }

        const existing = localStorage.getItem(`unlocked_teks_${teamName}`);
        if (existing) {
            alertDiv.innerHTML = '<div class="alert alert-warning">⚠️ Η ομάδα υπάρχει ήδη</div>';
            return;
        }

        await saveTeam(teamName, {
            unlocked: [],
            timestamps: {},
            startTime: null,
            completedAt: null,
            totalTimeMs: null
        });
        
        alertDiv.innerHTML = `<div class="alert alert-success">✅ Η ομάδα "${teamName}" δημιουργήθηκε</div>`;
        document.getElementById('newTeamName').value = '';
        
        setTimeout(() => { alertDiv.innerHTML = ''; }, 3000);
        refreshTeams();
    }

    async function refreshTeams() {
        let teams = await getAllTeams();
        const container = document.getElementById('teamsContainer');
        const noTeams = document.getElementById('noTeams');
        const sortOrder = document.getElementById('sortOrder').value;

        console.log(`📊 Loaded ${teams.length} teams from Firebase/localStorage`);
        teams.forEach(t => console.log(`  - ${t.name}: ${t.unlocked.length} TEKs unlocked`));

        if (teams.length === 0) {
            container.innerHTML = '';
            noTeams.style.display = 'block';
            return;
        }

        // Sort teams
        teams = sortTeams(teams, sortOrder);

        noTeams.style.display = 'none';
        container.innerHTML = teams.map(team => {
            const progress = Math.round((team.unlocked.length / TOTAL_TEKS) * 100);
            const isCompleted = team.unlocked.length === TOTAL_TEKS;
            
            let timingHtml = '';
            if (team.startTime) {
                const now = new Date();
                const startTime = new Date(team.startTime);
                
                if (isCompleted && team.completedAt) {
                    timingHtml = `
                        <div class="timing-info completed">
                            <strong>⏱️ Χρόνος Ολοκλήρωσης:</strong>
                            ${formatTime(team.totalTimeMs)}
                            <div style="margin-top: 5px; font-size: 11px; color: #666;">
                                Ξεκίνησε: ${formatDateTime(team.startTime)}<br>
                                Ολοκληρώθηκε: ${formatDateTime(team.completedAt)}
                            </div>
                        </div>
                    `;
                } else {
                    const elapsed = now - startTime;
                    timingHtml = `
                        <div class="timing-info">
                            <strong>⏱️ Χρόνος σε εξέλιξη:</strong>
                            ${formatTime(elapsed)}
                            <div style="margin-top: 5px; font-size: 11px; color: #666;">
                                Ξεκίνησε: ${formatDateTime(team.startTime)}
                            </div>
                        </div>
                    `;
                }
            }
            
            return `
                <div class="team-card ${isCompleted ? 'completed' : ''}">
                    <h3>
                        <span style="font-size: 24px;">👥</span> 
                        ${team.name.toUpperCase()}
                        ${isCompleted ? '<span class="completion-badge">✅ ΟΛΟΚΛΗΡΩΘΗΚΕ</span>' : ''}
                    </h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%;">${progress}%</div>
                    </div>
                    <div class="team-stats">📊 ΞΕΚΛΕΙΔΩΜΕΝΑ: ${team.unlocked.length} / ${TOTAL_TEKS} ΣΤΟΙΧΕΙΑ</div>
                    ${timingHtml}
                    <div class="tek-grid">
                        ${Array.from({length: TOTAL_TEKS}, (_, i) => {
                            const tekNum = (i + 1).toString();
                            const isUnlocked = team.unlocked.includes(tekNum);
                            return `<div class="tek-box ${isUnlocked ? 'unlocked' : ''}">${i + 1}</div>`;
                        }).join('')}
                    </div>
                    <div class="team-actions">
                        <button class="btn btn-primary" onclick="viewTeam('${team.name}')">👁️ ΠΡΟΒΟΛΗ</button>
                        <button class="btn" style="background: #17a2b8; color: white;" onclick="showTimestamps('${team.name}')">🕐 ΧΡΟΝΙΚΑ</button>
                        <button class="btn btn-success" onclick="unlockAll('${team.name}')">🔓 ΟΛΑ</button>
                        <button class="btn btn-secondary" onclick="resetTeam('${team.name}')">🔄 RESET</button>
                        <button class="btn btn-danger" onclick="deleteTeam('${team.name}')">🗑️ DELETE</button>
                    </div>
                </div>
            `;
        }).join('');
        
        // Show last refresh time
        const now = new Date().toLocaleTimeString('el-GR');
        const lastRefreshEl = document.getElementById('lastRefresh');
        if (lastRefreshEl) {
            lastRefreshEl.innerHTML = `
                <span class="icon">🔄</span>
                <span>Τελευταία ενημέρωση: ${now}</span>
            `;
        }
    }

    function sortTeams(teams, order) {
        switch(order) {
            case 'name':
                return teams.sort((a, b) => a.name.localeCompare(b.name));
            
            case 'progress':
                return teams.sort((a, b) => b.unlocked.length - a.unlocked.length);
            
            case 'completion':
                // Completed teams first, sorted by time, then incomplete teams
                const completed = teams.filter(t => t.completedAt).sort((a, b) => a.totalTimeMs - b.totalTimeMs);
                const incomplete = teams.filter(t => !t.completedAt).sort((a, b) => b.unlocked.length - a.unlocked.length);
                return [...completed, ...incomplete];
            
            case 'recent':
                return teams.sort((a, b) => {
                    const aTime = a.lastUpdate || a.startTime || '0';
                    const bTime = b.lastUpdate || b.startTime || '0';
                    return bTime.localeCompare(aTime);
                });
            
            default:
                return teams;
        }
    }

    async function showTimestamps(teamName) {
        const teams = await getAllTeams();
        const team = teams.find(t => t.name === teamName);
        
        if (!team) return;

        const modal = document.getElementById('timestampModal');
        const modalTeamName = document.getElementById('modalTeamName');
        const modalContent = document.getElementById('modalContent');

        modalTeamName.textContent = `Χρονικά Σημεία - ${teamName.toUpperCase()}`;

        let html = '';
        
        if (team.startTime) {
            html += `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>🚀 Έναρξη:</strong> ${formatDateTime(team.startTime)}
                </div>
            `;
        }

        if (team.completedAt) {
            html += `
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>🏁 Ολοκλήρωση:</strong> ${formatDateTime(team.completedAt)}<br>
                    <strong>⏱️ Συνολικός Χρόνος:</strong> ${formatTime(team.totalTimeMs)}
                </div>
            `;
        }

        if (team.timestamps && Object.keys(team.timestamps).length > 0) {
            html += '<h3 style="margin: 20px 0 10px 0;">Ξεκλειδώματα ΤΕΚ:</h3>';
            html += '<ul class="timestamp-list">';
            
            // Sort by timestamp
            const sortedTeks = Object.entries(team.timestamps)
                .sort((a, b) => new Date(a[1]) - new Date(b[1]));
            
            sortedTeks.forEach(([tek, timestamp]) => {
                html += `
                    <li class="timestamp-item">
                        <span class="tek-label">ΤΕΚ #${tek.padStart(2, '0')}</span>
                        <span class="time">${formatDateTime(timestamp)}</span>
                    </li>
                `;
            });
            
            html += '</ul>';
        } else {
            html += '<p style="color: #999; text-align: center; padding: 20px;">Δεν υπάρχουν χρονικά δεδομένα</p>';
        }

        modalContent.innerHTML = html;
        modal.classList.add('active');
    }

    function closeModal() {
        const modal = document.getElementById('timestampModal');
        modal.classList.remove('active');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('timestampModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    function viewTeam(teamName) {
        window.open(`${BASE_URL}index.html?team=${teamName}`, '_blank');
    }

    async function unlockAll(teamName) {
        if (confirm(`Ξεκλείδωμα όλων των TEKs για την ομάδα "${teamName}";`)) {
            const allTeks = Array.from({length: TOTAL_TEKS}, (_, i) => (i + 1).toString());
            const now = new Date().toISOString();
            const timestamps = {};
            allTeks.forEach((tek, i) => {
                timestamps[tek] = new Date(Date.now() + i * 1000).toISOString(); // Stagger by 1 second
            });
            
            await saveTeam(teamName, {
                unlocked: allTeks,
                timestamps: timestamps,
                startTime: now,
                completedAt: now,
                totalTimeMs: allTeks.length * 1000
            });
            refreshTeams();
        }
    }

    async function resetTeam(teamName) {
        if (confirm(`Reset πρόοδο για την ομάδα "${teamName}";`)) {
            await saveTeam(teamName, {
                unlocked: [],
                timestamps: {},
                startTime: null,
                completedAt: null,
                totalTimeMs: null
            });
            refreshTeams();
        }
    }

    async function deleteTeam(teamName) {
        if (confirm(`Διαγραφή ομάδας "${teamName}";`)) {
            localStorage.removeItem(`unlocked_teks_${teamName}`);
            if (isFirebaseReady()) {
                try {
                    await window.firebaseDeleteDoc(
                        window.firebaseDoc(window.firebaseDB, 'teams', teamName)
                    );
                } catch (error) {
                    console.error('Firebase delete error:', error);
                }
            }
            refreshTeams();
        }
    }

    async function unlockAllForAll() {
        if (confirm('Ξεκλείδωμα ΟΛΩΝ των TEKs για ΟΛΕΣ τις ομάδες;')) {
            const teams = await getAllTeams();
            const allTeks = Array.from({length: TOTAL_TEKS}, (_, i) => (i + 1).toString());
            const now = new Date().toISOString();
            
            for (const team of teams) {
                const timestamps = {};
                allTeks.forEach((tek, i) => {
                    timestamps[tek] = new Date(Date.now() + i * 1000).toISOString();
                });
                
                await saveTeam(team.name, {
                    unlocked: allTeks,
                    timestamps: timestamps,
                    startTime: now,
                    completedAt: now,
                    totalTimeMs: allTeks.length * 1000
                });
            }
            refreshTeams();
        }
    }

    async function resetAll() {
        if (confirm('ΔΙΑΓΡΑΦΗ ΟΛΩΝ των ομάδων;')) {
            const teams = await getAllTeams();
            for (const team of teams) {
                localStorage.removeItem(`unlocked_teks_${team.name}`);
                if (isFirebaseReady()) {
                    try {
                        await window.firebaseDeleteDoc(
                            window.firebaseDoc(window.firebaseDB, 'teams', team.name)
                        );
                    } catch (error) {
                        console.error('Firebase delete error:', error);
                    }
                }
            }
            refreshTeams();
        }
    }

    function generateUrls() {
        const teamName = document.getElementById('urlTeamName').value.trim().toLowerCase();
        const output = document.getElementById('urlOutput');
        const urlList = document.getElementById('urlList');

        if (!teamName) {
            alert('Παρακαλώ εισάγετε όνομα ομάδας');
            return;
        }

        const urls = [];
        urls.push(`<strong>Entry URL:</strong><br>${BASE_URL}index.html?team=${teamName}<br><br>`);
        urls.push(`<strong>Unlock URLs:</strong><br>`);
        
        for (let i = 1; i <= TOTAL_TEKS; i++) {
            urls.push(`TEK ${i.toString().padStart(2, '0')}: ${BASE_URL}unlock_system.html?tek=${i}&team=${teamName}`);
        }

        urlList.innerHTML = urls.join('<br>');
        output.style.display = 'block';
    }

    function copyAllUrls() {
        const urlList = document.getElementById('urlList');
        const text = urlList.innerText;
        
        navigator.clipboard.writeText(text).then(() => {
            alert('✅ URLs αντιγράφηκαν στο clipboard!');
        });
    }

    // === INITIALIZATION ===
    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            const status = document.getElementById('firebaseStatus');
            if (isFirebaseReady()) {
                status.style.display = 'block';
                status.innerHTML = '✅ Firebase Συνδεδεμένο - Αυτόματη ενημέρωση κάθε 5 δευτ.';
            } else {
                console.warn('⚠️ Firebase not loaded - using localStorage only');
            }
            
            refreshTeams();
        }, 300);
    });

    // Auto-refresh every 5 seconds to show real-time updates
    setInterval(refreshTeams, 5000);
</script>
</body>
</html>